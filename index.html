<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <title>‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ - ‡∂∏‡∑ú/‡∂ú‡∂∏‡∑ä‡∂¥‡∂Ç‡∂ú‡∑î‡∑Ä ‡∂ö‡∂±‡∑í‡∑Ç‡∑ä‡∂® ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂Ω‡∂∫</title>
    <style>
        :root { 
            --primary: #1a252f; --secondary: #2c3e50; --accent: #2980b9;
            --success: #27ae60; --danger: #c0392b; --light: #f4f7f6; --project: #8e44ad;
            --gold: #f1c40f;
        }
        body { font-family: 'Segoe UI', 'Iskoola Pota', Arial, sans-serif; margin: 0; display: flex; background: var(--light); flex-direction: column; }
        
        #login-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: var(--primary);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box { background: white; padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }

        .top-header { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; padding: 20px; text-align: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 101;
        }
        .top-header h1 { margin: 0; font-size: 28px; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }
        .top-header h2 { margin: 5px 0 0; font-size: 20px; font-weight: 300; color: #ecf0f1; }

        .app-container { display: none; width: 100%; }

        .sidebar { width: 280px; height: calc(100vh - 100px); background: var(--primary); color: white; position: fixed; top: 105px; padding-top: 10px; box-shadow: 2px 0 10px rgba(0,0,0,0.3); z-index: 100; overflow-y: auto; }
        .nav-link { padding: 12px 20px; display: block; color: #bdc3c7; text-decoration: none; cursor: pointer; transition: 0.3s; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .nav-link:hover, .nav-link.active { background: var(--secondary); color: white; border-left: 5px solid var(--accent); }

        .main-content { margin-left: 280px; padding: 40px; width: calc(100% - 280px); margin-top: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        .row { display: flex; gap: 20px; margin-bottom: 15px; }
        .field { flex: 1; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #444; font-size: 13px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box; background: #fafafa; }
        
        button { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-save { background: var(--success); color: white; width: 100%; }
        .btn-proj { background: var(--project); color: white; width: 100%; }
        .btn-print { background: var(--accent); color: white; margin-top: 20px; padding: 10px 30px; }
        .btn-del { background: #e74c3c; color: white; padding: 5px 10px; font-size: 11px; border-radius: 4px; border: none; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th { background: #f8f9fa; color: var(--primary); padding: 12px; border: 1px solid #dee2e6; text-align: left; font-size: 13px; }
        td { padding: 10px; border: 1px solid #dee2e6; font-size: 13px; }
        
        .in-amt { color: var(--success); font-weight: bold; }
        .ex-amt { color: var(--danger); font-weight: bold; }
        .guest-hide { display: none !important; }

        .chq-col { width: 85px; font-size: 10px !important; text-align: center; padding: 5px !important; }
        .chq-col input { width: 14px; height: 14px; vertical-align: middle; cursor: pointer; }

        .designer-tag { 
            position: relative; margin-top: 20px; width: 100%; text-align: center; 
            padding: 10px 0; background: rgba(0,0,0,0.2); color: var(--gold); 
            font-weight: bold; font-size: 13px; border-top: 1px solid var(--accent);
        }

        .footer-note { text-align: center; font-size: 14px; color: var(--primary); margin-top: 30px; font-weight: bold; padding: 20px; border-top: 2px solid var(--accent); }
        #sync-status { font-size: 11px; color: #f1c40f; padding: 5px 25px; }

        .filter-box { background: #eef2f3; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #d1d8e0; }

        @media print { 
            .sidebar, button, .no-print, .designer-tag, .btn-del, input[type="checkbox"], .filter-box { display: none !important; }
            .main-content { margin-left: 0; width: 100%; padding: 0; margin-top: 0; }
            .top-header { background: white !important; color: black !important; border-bottom: 2px solid black; }
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color: var(--primary)">‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∂ß ‡∂á‡∂≠‡∑î‡∑Ö‡∑î ‡∑Ä‡∑ì‡∂∏</h2>
        <input type="password" id="passInput" placeholder="‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±" style="margin-bottom: 15px; text-align: center;">
        <button class="btn-save" onclick="checkLogin()">‡∂á‡∂≠‡∑î‡∑Ö‡∑î ‡∑Ä‡∂±‡∑ä‡∂±</button>
        <p style="font-size: 11px; color: #666; margin-top: 10px;">Guest ‡∂Ö‡∑Ä‡∑É‡∂ª‡∂∫ ‡∑É‡∂≥‡∑Ñ‡∑è "Guest" ‡∂Ω‡∑ô‡∑É ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.</p>
    </div>
</div>

<div class="top-header">
    <h1>‡∂∏‡∑ú/‡∂ú‡∂∏‡∑ä‡∂¥‡∂Ç‡∂ú‡∑î‡∑Ä ‡∂ö‡∂±‡∑í‡∑Ç‡∑ä‡∂® ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂Ω‡∂∫</h1>
    <h2>‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∂´ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫</h2>
</div>

<div class="app-container" id="appBody">
    <div class="sidebar no-print">
        <div id="sync-status">‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...</div>
        <a class="nav-link active" onclick="showSec('dash')">üìä ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂¥‡∑î‡∑Ä‡∂ª‡∑î‡∑Ä</a>
        <a class="nav-link admin-only" onclick="showSec('entry')">üìù ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏</a>
        <a class="nav-link" onclick="showSec('projects')">üèóÔ∏è ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í</a>
        <a class="nav-link" onclick="prepareReport('cash')">üìñ ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑ú‡∂≠</a>
        <a class="nav-link" onclick="prepareReport('fund')">üí∞ ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫</a>
        <a class="nav-link" onclick="prepareReport('exp_sum')">üí∏ ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫</a>
        <a class="nav-link" onclick="prepareReport('code_wise')">üîç ‡∂ö‡∑ö‡∂≠ ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è</a>
        <a class="nav-link" onclick="runReport('proj_rep')">üìã ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä</a>
        <a class="nav-link" onclick="runReport('recon')">üè¶ ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏</a>
        <a class="nav-link" onclick="showSec('guide')">üìò ‡∂ö‡∑ö‡∂≠ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</a>
        
        <div class="designer-tag">‡∂±‡∑í‡∂ª‡∑ä‡∂∏‡∑è‡∂´‡∂∫: ‡∂≠‡∂ª‡∂Ç‡∂ú ‡∑Ä‡∑í‡∂¢‡∑ö‡∑É‡∑í‡∂Ç‡∑Ñ</div>
    </div>

    <div class="main-content">
        <div id="sec-dash" class="section">
            <h3>‡∑Ä‡∂≠‡∑ä‡∂∏‡∂±‡∑ä ‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫ <span id="user-role-lbl" style="font-size:12px; color:var(--accent)"></span></h3>
            <div id="dash-stats" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:20px;"></div>
            <div class="card">
                <h4>‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∑Ñ‡∑è ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑Å‡∑ö‡∑Ç‡∂∫‡∂±‡∑ä</h4>
                <div id="dash-fund-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:10px;"></div>
            </div>
        </div>

        <div id="sec-entry" class="section" style="display:none;">
            <div class="card admin-only" style="border-left: 5px solid var(--gold); margin-bottom: 25px;">
                <h3>‡∑Ä‡∂ª‡∑ä‡∑Ç‡∂∫ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫‡∂±‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏</h3>
                <div class="row">
                    <div class="field"><label>‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫</label><select id="openCode"></select></div>
                    <div class="field"><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="openDate"></div>
                    <div class="field"><label>‡∑Å‡∑ö‡∑Ç‡∂∫</label><input type="number" id="openAmt"></div>
                    <div class="field" style="align-self:flex-end;"><button class="btn-save" style="background:var(--gold); color:black;" onclick="addOpeningBal()">‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button></div>
                </div>
            </div>

            <div class="row">
                <div class="card field">
                    <h3 class="in-amt">‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä (Receipts)</h3>
                    <div class="row"><div class="field"><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="inDate"></div><div class="field"><label>‡∂Ω‡∂Ø‡∑î‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</label><input type="text" id="inRef"></div></div>
                    <div class="row"><div class="field"><label>‡∂ö‡∑ö‡∂≠‡∂∫</label><select id="inCode"></select></div><div class="field"><label>‡∂∏‡∑î‡∂Ø‡∂Ω</label><input type="number" id="inAmt"></div></div>
                    <label>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</label><textarea id="inDesc" rows="2" style="margin-bottom:15px;"></textarea>
                    <button class="btn-save" onclick="addTx('IN')">‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏ ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
                </div>
                <div class="card field">
                    <h3 class="ex-amt">‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä (Payments)</h3>
                    <div class="row"><div class="field"><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="exDate"></div><div class="field"><label>‡∑Ä‡∑Ä‡∑î‡∂†‡∂ª‡∂∫</label><input type="text" id="exRef"></div></div>
                    <div class="row"><div class="field"><label>‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫</label><select id="exCode"></select></div><div class="field"><label>‡∂∏‡∑î‡∂Ø‡∂Ω</label><input type="number" id="exAmt"></div></div>
                    <div class="row"><div class="field"><label>‡∂∏‡∑ñ‡∂Ω‡∑è‡∑Å‡∑ä‚Äç‡∂ª‡∂∫</label><select id="exSource"></select></div><div class="field"><label>‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫</label><select id="exProjLink"></select></div></div>
                    <div class="row"><div class="field"><label>‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</label><input type="text" id="exCheque"></div></div>
                    <label>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</label><textarea id="exDesc" rows="2" style="margin-bottom:15px;"></textarea>
                    <button class="btn-save" style="background:var(--danger)" onclick="addTx('EX')">‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
                </div>
            </div>
        </div>

        <div id="sec-projects" class="section" style="display:none;">
            <div class="card admin-only">
                <h3>‡∂±‡∑Ä ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫‡∂ö‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏</h3>
                <div class="row">
                    <div class="field"><label>‡∂±‡∂∏</label><input type="text" id="pName"></div>
                    <div class="field"><label>‡∂Ω‡∑ê‡∂∂‡∑î‡∂´‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω</label><input type="number" id="pAmt"></div>
                    <div class="field"><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="pDate"></div>
                    <div class="field" style="align-self:flex-end;"><button class="btn-proj" onclick="addProject()">‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button></div>
                </div>
            </div>
            <div class="card"><div id="projectListTable"></div></div>
        </div>

        <div id="sec-report" class="section" style="display:none;">
            <div class="card">
                <h2 id="rep-title" style="text-align:center;">‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä</h2>
                
                <div id="filter-area" class="filter-box no-print">
                    <div class="row">
                        <div class="field date-filter"><label>‡∑É‡∑í‡∂ß (From)</label><input type="date" id="fDate"></div>
                        <div class="field date-filter"><label>‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è (To)</label><input type="date" id="tDate"></div>
                        <div id="code-filter-field" class="field" style="display:none;">
                            <label>‡∂ö‡∑ö‡∂≠‡∂∫ ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±</label><select id="filterCodeSelect"></select>
                        </div>
                        <div class="field" style="align-self:flex-end;">
                            <button class="btn-save" style="width:auto; padding:10px 25px;" onclick="runFilteredReport()">‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
                        </div>
                    </div>
                </div>

                <div id="recon-inputs" class="no-print" style="display:none; background:#f9f9f9; padding:15px; margin-bottom:20px; border-radius:8px;">
                    <label>‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂±‡∂∫‡∑ö ‡∑Å‡∑ö‡∑Ç‡∂∫ (Bank Statement Balance):</label>
                    <input type="number" id="bankStatementAmt" style="width:200px; display:inline-block; margin:10px 0;">
                    <button class="btn-save" style="width:auto; padding:8px 20px;" onclick="calculateRecon()">‡∑É‡∑ê‡∑É‡∂Ø‡∑î‡∂∏ ‡∑É‡∑è‡∂Ø‡∂±‡∑ä‡∂±</button>
                </div>
                <div id="rep-body"></div>
                <button class="btn-print no-print" onclick="window.print()">‡∂∏‡∑î‡∂Ø‡∑ä‚Äç‡∂ª‡∂´‡∂∫</button>
                <div class="footer-note">‡∂±‡∑í‡∂ª‡∑ä‡∂∏‡∑è‡∂´‡∂∫ ‡∑Ñ‡∑è ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´‡∂∫:‡∂≠‡∂ª‡∂Ç‡∂ú ‡∑Ä‡∑í‡∂¢‡∑ö‡∑É‡∑í‡∂Ç‡∑Ñ-0777944308</div>
            </div>
        </div>

        <div id="sec-guide" class="section" style="display:none;">
            <div class="card">
                <h3>‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í ‡∂ö‡∑ö‡∂≠ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</h3>
                <div class="row">
                    <div class="field">
                        <h4 class="in-amt">‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠ (Income Codes)</h4>
                        <table style="font-size: 12px;">
                            <tr><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th></tr>
                            <tr><td>S1</td><td>‡∂í‡∂ö‡∑è‡∂∂‡∂Ø‡∑ä‡∂∞ ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∑É‡∑Ñ ‡∂¥‡∑Ö‡∑è‡∂≠‡∑ä ‡∑É‡∂∑‡∑è ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä</td></tr>
                            <tr><td>S2</td><td>‡∑É‡∑Ñ‡∂∫‡∑ù‡∂ú‡∑í‡∂≠‡∑è ‡∂ú‡∑í‡∑Ä‡∑í‡∑É‡∑î‡∂∏‡∑ä ‡∂∫‡∂ß‡∂≠‡∑ö ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∂± ‡∑Ä‡∑ê‡∂©‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∑Ñ‡∑è ‡∑Ä‡∑ò‡∂≠‡∑ä‡∂≠‡∑ì‡∂∫ ‡∂ö‡∂ß‡∂∫‡∑î‡∂≠‡∑î ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä</td></tr>
                            <tr><td>S3</td><td>‡∂ª‡∂¢‡∂∫‡∑ö ‡∂Ü‡∂∞‡∑è‡∂ª</td></tr>
                            <tr><td>S4</td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∂¥‡∑è‡∂Ø‡∂ö ‡∂â‡∂ú‡∑ô‡∂±‡∑î‡∂∏‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∂ª‡∑ä‡∂∞‡∂± ‡∂¥‡∑ä‚Äç‡∂ª‡∂Ø‡∑è‡∂±‡∂∫‡∂±‡∑ä, ‡∂ú‡∑î‡∂´‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂∫‡∑ô‡∂Ø‡∑Ä‡∑î‡∂∏‡∑ä ‡∑Ñ‡∑è ‡∂ã‡∑É‡∑É‡∑ä ‡∂∏‡∂ß‡∑ä‡∂ß‡∂∏‡∑ö ‡∂â‡∂ú‡∑ô‡∂±‡∑î‡∂∏‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä</td></tr>
                            <tr><td>S5</td><td>‡∂ª‡∂¢‡∂∫ ‡∑Ä‡∑í‡∑É‡∑í‡∂±‡∑ä ‡∂Ö‡∂±‡∑î‡∂∏‡∂≠ ‡∑Ñ‡∑è ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∂ª‡∑è‡∂¢‡∑ä‚Äç‡∂∫ ‡∂±‡∑ú‡∑Ä‡∂± ‡∑É‡∂Ç‡∑Ä‡∑í‡∂∞‡∑è‡∂± ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂Ü‡∂∞‡∑è‡∂ª</td></tr>
                            <tr><td>S6</td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î‡∑Ä ‡∑Ä‡∑ô‡∂±‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∑É‡∑ä‡∑Ä‡∂ö‡∑ê‡∂∏‡∑ê‡∂≠‡∑ä‡∂≠‡∑ô‡∂±‡∑ä ‡∂Ø‡∑è‡∂∫‡∂ö‡∂≠‡∑ä‡∑Ä‡∂∫ ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂± ‡∂ï‡∂±‡∑ë‡∂∏ ‡∂¥‡∑è‡∂ª‡∑ä‡∑Å‡∑Ä‡∂∫‡∂ö ‡∂¥‡∂ª‡∑í‡∂≠‡∑ä‚Äç‡∂∫‡∑è‡∂ú</td></tr>
                            <tr><td>S7</td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∂ß ‡∂Ö‡∂∫‡∂≠‡∑ä ‡∑Ä‡∂≠‡∑ä‡∂ö‡∂∏‡∑ä ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä ‡∂ã‡∂¥‡∂∫‡∑è ‡∂ú‡∂±‡∑ä‡∂±‡∑è ‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏‡∑ä</td></tr>
                            <tr><td>S8</td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∑É‡∂Ç‡∑Ä‡∂ª‡∑ä‡∂∞‡∂± ‡∑É‡∂∏‡∑í‡∂≠‡∑í ‡∑É‡∑è‡∂∏‡∑è‡∂¢‡∑í‡∂ö ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä</td></tr>
                            <tr><td>S9</td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂â‡∂ú‡∑ô‡∂±‡∑î‡∂∏‡∑ä-‡∂â‡∂ú‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í‡∂∫‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∂Ö‡∂≠‡∑ä‚Äç‡∂∫‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∂ö‡∂∏‡∑ä ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä</td></tr>
                            <tr><td>S10</td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∑É‡∂Ç‡∑Ä‡∂ª‡∑ä‡∂∞‡∂± ‡∑É‡∂∏‡∑í‡∂≠‡∑í‡∂∫ ‡∂∏‡∂ú‡∑í‡∂±‡∑ä ‡∂≠‡∑ì‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂±‡∑î ‡∂Ω‡∂∂‡∂± ‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂Ö‡∂≠‡∑ä‚Äç‡∂∫‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂¥‡∑í‡∂∫‡∑Ä‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑Ä‡∑ñ ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä</td></tr>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="field">
                        <h4 class="ex-amt">‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠ (Expenditure Codes)</h4>
                        <table style="font-size: 12px;">
                            <tr><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th></tr>
                            <tr><td>REx1</td><td>‡∑Ä‡∑í‡∑Ç‡∂∫ ‡∂∏‡∑è‡∂Ω‡∑è ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∂¥‡∑î‡∂±‡∂ª‡∑è‡∑Ä‡∂ª‡∑ä‡∂≠‡∂± ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä</td></tr>
                            <tr><td>REx2</td><td>‡∂ã‡∂¥‡∂Ø‡∑ö‡∑Å‡∂±, ‡∂ã‡∑É‡∑É‡∑ä ‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂± ‡∑Ñ‡∑è ‡∑Ä‡∑í‡∑Ç‡∂∫ ‡∑É‡∂∏‡∂ú‡∑è‡∂∏‡∑ì ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∂ö‡∂∏‡∑ä</td></tr>
                            <tr><td>REx3</td><td>‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂± ‡∂¥‡∂ª‡∑í‡∂¥‡∑è‡∂Ω‡∂±, ‡∂ã‡∂¥‡∂∫‡∑ù‡∂ú‡∑í‡∂≠‡∑è ‡∑É‡∑ö‡∑Ä‡∑è ‡∑Ñ‡∑è ‡∑É‡∑î‡∂∑‡∑É‡∑è‡∂∞‡∂± ‡∂ö‡∂ß‡∂∫‡∑î‡∂≠‡∑î</td></tr>
                            <tr><td>REx4</td><td>‡∂ö‡∑è‡∂ª‡∑ä‡∂∫ ‡∂∏‡∂´‡∑ä‡∂©‡∂Ω ‡∂¥‡∑è‡∂ª‡∑í‡∑Å‡∑ä‚Äç‡∂ª‡∂∏‡∑í‡∂ö</td></tr>
                            <tr><td>REx5</td><td>‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∂∑‡∑è‡∂´‡∑ä‡∂© ‡∑Ñ‡∑è ‡∂ã‡∂¥‡∂ö‡∂ª‡∂´ ‡∂±‡∂©‡∂≠‡∑ä‡∂≠‡∑î ‡∑Ñ‡∑è ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è</td></tr>
                            <tr><td>REx6</td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∂ú‡∑ú‡∂©‡∂±‡∑ê‡∂ú‡∑í‡∂Ω‡∑í ‡∑É‡∑î‡∑Ö‡∑î ‡∂±‡∂©‡∂≠‡∑ä‡∂≠‡∑î ‡∑Ñ‡∑è ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è</td></tr>
                            <tr><td>REx7</td><td>‡∂¥‡∑Ä‡∑í‡∂≠‡∑ä‚Äç‡∂ª‡∂≠‡∑è ‡∑Ñ‡∑è ‡∂¥‡∑í‡∂ª‡∑í‡∑É‡∑í‡∂Ø‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä</td></tr>
                            <tr><td>CEx1</td><td>‡∂∏‡∑ñ‡∂Ω‡∑í‡∂ö ‡∂¥‡∑Ñ‡∑É‡∑î‡∂ö‡∂∏‡∑ä - ‡∂±‡∑Ä ‡∑É‡∑ê‡∂¥‡∂∫‡∑ì‡∂∏‡∑ä</td></tr>
                            <tr><td>CEx2</td><td>‡∑Ä‡∑í‡∑Ç‡∂∫ ‡∂∏‡∑è‡∂Ω‡∑è ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä</td></tr>
                            <tr><td>CEx3</td><td>‡∂¥‡∑î‡∑É‡∑ä‡∂≠‡∂ö‡∑è‡∂Ω ‡∂¥‡∑ú‡∂≠‡∑ä ‡∂∏‡∑í‡∂Ω‡∂ß ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ä</td></tr>
                            <tr><td>CEx4</td><td>‡∂ú‡∑ú‡∂©‡∂±‡∑ê‡∂ú‡∑í‡∂Ω‡∑í ‡∂±‡∑Ä ‡∂â‡∂Ø‡∑í‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä, ‡∑Ä‡∑ê‡∂©‡∑í‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä ‡∑Ñ‡∑è ‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä</td></tr>
                            <tr><td>CEx5</td><td>‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∂ã‡∂¥‡∂ö‡∂ª‡∂´ ‡∂∏‡∑í‡∂Ω‡∂ß ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ä</td></tr>
                            <tr><td>CEx6</td><td>‡∂Ö‡∂≠‡∑í‡∂ª‡∑ö‡∂ö ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∂Ü‡∂∞‡∑è‡∂ª</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwuT7SdENJsFlXTf7o_tV2l20d-iu3K9IlRLYex6GYx9zT_RKLw9qtJv-1fKQL2NUVJ/exec";
    const MASTER_PASS = "Tharanga";
    const GUEST_PASS = "Guest";

    const S = ["S1", "S2", "S3", "S4", "S5", "S6", "S7", "S8", "S9", "S10"];
    const EX = ["REx1", "REx2", "REx3", "REx4", "REx5", "REx6", "REx7", "CEx1", "CEx2", "CEx3", "CEx4", "CEx5", "CEx6"];

    let currentReportType = '';

    window.onload = () => { if(sessionStorage.getItem('isLogged')) unlockApp(); };

    function checkLogin() {
        let p = document.getElementById('passInput').value;
        if(p === MASTER_PASS) { sessionStorage.setItem('isLogged', 't'); sessionStorage.setItem('role', 'admin'); unlockApp(); }
        else if(p === GUEST_PASS) { sessionStorage.setItem('isLogged', 't'); sessionStorage.setItem('role', 'guest'); unlockApp(); }
        else alert("‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í!");
    }

    function unlockApp() {
        let role = sessionStorage.getItem('role');
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('appBody').style.display = 'flex';
        document.getElementById('user-role-lbl').innerText = role === 'guest' ? "(Guest - View Only)" : "(Admin)";
        if(role === 'guest') document.querySelectorAll('.admin-only').forEach(e => e.classList.add('guest-hide'));
        setupDrops(); refreshDash(); syncFromCloud();
    }

    async function syncToCloud() {
        if(sessionStorage.getItem('role') === 'guest') return;
        document.getElementById('sync-status').innerText = "‡∑É‡∑î‡∂ª‡∑ê‡∂ö‡∑ô‡∂∏‡∑í‡∂±‡∑ä...";
        const data = { db: localStorage.getItem('sch_db'), projs: localStorage.getItem('sch_projs') };
        try { await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) }); document.getElementById('sync-status').innerText = "Cloud ‡∑É‡∂∏‡∂ú ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞‡∂∫‡∑í ‚úÖ"; }
        catch(e) { document.getElementById('sync-status').innerText = "Sync ‡∂Ö‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í ‚ö†Ô∏è"; }
    }

    async function syncFromCloud() {
        try {
            const res = await fetch(GOOGLE_SCRIPT_URL);
            const cloudData = await res.json();
            if(cloudData.db) localStorage.setItem('sch_db', cloudData.db);
            if(cloudData.projs) localStorage.setItem('sch_projs', cloudData.projs);
            setupDrops(); refreshDash();
        } catch(e) { console.log("Cloud sync error."); }
    }

    function setupDrops() {
        const inC = document.getElementById('inCode');
        const exC = document.getElementById('exCode');
        const exS = document.getElementById('exSource');
        const opC = document.getElementById('openCode');
        const filC = document.getElementById('filterCodeSelect');

        const sOptions = S.map(c => `<option>${c}</option>`).join('');
        inC.innerHTML = sOptions;
        exC.innerHTML = EX.map(c => `<option>${c}</option>`).join('');
        exS.innerHTML = sOptions;
        opC.innerHTML = sOptions;
        filC.innerHTML = '<optgroup label="‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä">' + S.map(c => `<option value="${c}">${c}</option>`).join('') + '</optgroup>' + 
                         '<optgroup label="‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä">' + EX.map(c => `<option value="${c}">${c}</option>`).join('') + '</optgroup>';

        const projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        document.getElementById('exProjLink').innerHTML = '<option value="">-- ‡∂±‡∑ê‡∂≠ --</option>' + projs.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        renderProjectList();
    }

    function showSec(id) {
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.getElementById('sec-' + id).style.display = 'block';
        if(id !== 'report') {
            document.getElementById('recon-inputs').style.display = 'none';
        }
    }

    function addOpeningBal() {
        if(sessionStorage.getItem('role') === 'guest') return;
        const code = document.getElementById('openCode').value;
        const amt = parseFloat(document.getElementById('openAmt').value || 0);
        const date = document.getElementById('openDate').value;
        if(!date || amt < 0) return alert("‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.");
        
        const d = {
            id: 'open_' + Date.now(), type: 'IN', date, ref: 'OP-BAL',
            code, amt, desc: '‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫ (' + code + ')',
            source: code, cheque: '-', proj: '', realized: true
        };
        let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        db.push(d);
        localStorage.setItem('sch_db', JSON.stringify(db));
        syncToCloud(); refreshDash(); alert("‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫ ‡∑É‡∑î‡∂ª‡∑ê‡∂ö‡∑î‡∂´‡∑í.");
    }

    function toggleRealized(id, status) {
        if(sessionStorage.getItem('role') === 'guest') return;
        let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        let idx = db.findIndex(r => r.id === id);
        if(idx !== -1) {
            db[idx].realized = status;
            localStorage.setItem('sch_db', JSON.stringify(db));
            syncToCloud();
        }
    }

    function addTx(type) {
        if(sessionStorage.getItem('role') === 'guest') return;
        const p = type === 'IN' ? 'in' : 'ex';
        const amt = parseFloat(document.getElementById(p+'Amt').value || 0);
        const date = document.getElementById(p+'Date').value;
        if(!date || amt <= 0) return alert("‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.");
        const d = {
            id: 'tx_' + Date.now(), type, date, ref: document.getElementById(p+'Ref').value,
            code: document.getElementById(p+'Code').value, amt, desc: document.getElementById(p+'Desc').value,
            source: type==='EX'?document.getElementById('exSource').value:document.getElementById(p+'Code').value,
            cheque: type==='EX'?document.getElementById('exCheque').value:'-',
            proj: type==='EX' ? document.getElementById('exProjLink').value : '',
            realized: true 
        };
        let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        db.push(d);
        localStorage.setItem('sch_db', JSON.stringify(db));
        syncToCloud(); location.reload();
    }

    function prepareReport(type) {
        currentReportType = type;
        showSec('report');
        
        // Handle code filter visibility
        document.getElementById('code-filter-field').style.display = (type === 'code_wise') ? 'block' : 'none';
        
        // Hide/Show Date filters for Recon and Proj reports as requested
        const dateFields = document.querySelectorAll('.date-filter');
        if(type === 'recon' || type === 'proj_rep') {
            dateFields.forEach(f => f.style.display = 'none');
            document.getElementById('filter-area').style.display = 'none';
        } else {
            dateFields.forEach(f => f.style.display = 'block');
            document.getElementById('filter-area').style.display = 'block';
        }

        runFilteredReport();
    }

    function runFilteredReport() {
        const fromDate = document.getElementById('fDate').value;
        const toDate = document.getElementById('tDate').value;
        const filterCode = document.getElementById('filterCodeSelect').value;
        runReport(currentReportType, fromDate, toDate, filterCode);
    }

    function runReport(type, from = '', to = '', codeFilter = '') {
        showSec('report');
        let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        const projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        const role = sessionStorage.getItem('role');
        
        // Filter by date (only if type is not recon or proj_rep)
        if(type !== 'recon' && type !== 'proj_rep') {
            if(from) db = db.filter(r => r.date >= from);
            if(to) db = db.filter(r => r.date <= to);
        }

        let html = '', title = '';

        if(type === 'recon') {
            title = "‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏"; 
            document.getElementById('filter-area').style.display = 'none';
            document.getElementById('recon-inputs').style.display = 'block';
            document.getElementById('rep-body').innerHTML = "‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑Å‡∑ö‡∑Ç‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª ‡∂∂‡∑ú‡∂≠‡∑ä‡∂≠‡∂∏ ‡∂î‡∂∂‡∂±‡∑ä‡∂±.";
            document.getElementById('rep-title').innerText = title;
            return;
        }

        if(type === 'cash') {
            title = "‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑ú‡∂≠";
            html = `<table><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä (+)</th><th>‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä (-)</th><th>‡∑Å‡∑ö‡∑Ç‡∂∫</th><th class="chq-col">‡∂∏‡∑è‡∂ª‡∑î ‡∑Ä‡∑ì‡∂∏</th></tr>`;
            let bal = 0;
            let combined = [...db.map(r=>({...r, isP:false})), ...projs.map(p=>({id:p.id, type:'IN', date:p.date, desc:'Proj: '+p.name, code:'PROJ', amt:p.initialAmt, realized:true, isP:true}))];
            combined.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(r => {
                bal += (r.type==='IN'?r.amt:-r.amt);
                let check = (r.type==='EX' && r.cheque !== '-') ? `<input type="checkbox" ${r.realized?'checked':''} ${role==='guest'?'disabled':''} onchange="toggleRealized('${r.id}', this.checked)"><br>${r.realized?'‡∂î‡∑Ä‡∑ä':'‡∂±‡∑ê‡∂≠'}` : '-';
                html += `<tr><td>${r.date}</td><td>${r.desc}</td><td>${r.code}</td><td class="in-amt">${r.type==='IN'?r.amt.toFixed(2):'-'}</td><td class="ex-amt">${r.type==='EX'?r.amt.toFixed(2):'-'}</td><td><b>${bal.toFixed(2)}</b></td><td class="chq-col">${check}</td></tr>`;
            });
        } else if(type === 'fund') {
            title = "‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫";
            html = `<table><tr><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä</th><th>‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä</th><th>‡∑Å‡∑ö‡∑Ç‡∂∫</th></tr>`;
            S.forEach(s => {
                let tin = db.filter(r=>r.code===s && r.type==='IN').reduce((a,b)=>a+b.amt,0);
                let tout = db.filter(r=>r.source===s && r.type==='EX').reduce((a,b)=>a+b.amt,0);
                html += `<tr><td>${s}</td><td>${tin.toFixed(2)}</td><td>${tout.toFixed(2)}</td><td><b>${(tin-tout).toFixed(2)}</b></td></tr>`;
            });
        } else if(type === 'exp_sum') {
            title = "‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫";
            html = `<table><tr><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω</th></tr>`;
            let tot = 0;
            EX.forEach(c => {
                let a = db.filter(r=>r.type==='EX' && r.code===c).reduce((a,b)=>a+b.amt,0);
                html += `<tr><td>${c}</td><td class="ex-amt">${a.toFixed(2)}</td></tr>`; tot += a;
            });
            html += `<tr style="background:#eee;"><td><b>‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä</b></td><td class="ex-amt"><b>${tot.toFixed(2)}</b></td></tr>`;
        } else if(type === 'code_wise') {
            title = "‡∂ö‡∑ö‡∂≠‡∂∫ ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä: " + codeFilter;
            html = `<table><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä (+)</th><th>‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä (-)</th></tr>`;
            let cIn = 0, cOut = 0;
            db.filter(r => r.code === codeFilter || r.source === codeFilter).forEach(r => {
                let showIn = (r.type === 'IN' && r.code === codeFilter) ? r.amt : 0;
                let showOut = (r.type === 'EX' && r.code === codeFilter) ? r.amt : 0; 
                if(r.type === 'EX' && r.source === codeFilter && r.code !== codeFilter) showOut = r.amt;

                html += `<tr><td>${r.date}</td><td>${r.desc}</td><td class="in-amt">${showIn?showIn.toFixed(2):'-'}</td><td class="ex-amt">${showOut?showOut.toFixed(2):'-'}</td></tr>`;
                cIn += showIn; cOut += showOut;
            });
            html += `<tr style="background:#eee;"><td><b>‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä</b></td><td></td><td class="in-amt">${cIn.toFixed(2)}</td><td class="ex-amt">${cOut.toFixed(2)}</td></tr>`;
        } else if(type === 'proj_rep') {
            title = "‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä";
            document.getElementById('filter-area').style.display = 'none';
            html = `<table><tr><th>‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫</th><th>‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä</th><th>‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä</th><th>‡∑Å‡∑ö‡∑Ç‡∂∫</th></tr>`;
            projs.forEach(p => {
                let cost = db.filter(r=>r.proj===p.name).reduce((a,b)=>a+b.amt,0);
                html += `<tr><td>${p.name}</td><td>${p.initialAmt.toFixed(2)}</td><td class="ex-amt">${cost.toFixed(2)}</td><td><b>${(p.initialAmt-cost).toFixed(2)}</b></td></tr>`;
            });
        }
        document.getElementById('rep-title').innerText = title;
        document.getElementById('rep-body').innerHTML = html + "</table>";
    }

    function calculateRecon() {
        const bankStmt = parseFloat(document.getElementById('bankStatementAmt').value || 0);
        const db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        const projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        const cashBookBal = (db.filter(r=>r.type==='IN').reduce((a,b)=>a+b.amt,0) + projs.reduce((a,b)=>a+b.initialAmt,0)) - db.filter(r=>r.type==='EX').reduce((a,b)=>a+b.amt,0);
        
        const unpresented = db.filter(r => r.type === 'EX' && r.cheque !== '-' && !r.realized);
        const totalUnpresented = unpresented.reduce((a,b) => a+b.amt, 0);

        let html = `<table style="max-width:600px; margin:auto; border:2px solid var(--primary);">
            <tr><th colspan="2" style="text-align:center;">‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂∫</th></tr>
            <tr><td>‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑ú‡∂≠‡∑ö ‡∑Å‡∑ö‡∑Ç‡∂∫</td><td style="text-align:right;"><b>${cashBookBal.toFixed(2)}</b></td></tr>
            <tr><td>(+) ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î‡∑Ä‡∂ß ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂¥‡∂≠‡∑ä ‡∂±‡∑ú‡∂ö‡∑Ö ‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä</td><td style="text-align:right; color:var(--success)">${totalUnpresented.toFixed(2)}</td></tr>
            <tr><td style="padding-left:20px; font-size:11px;"><i>${unpresented.map(u => u.cheque).join(', ') || '‡∂±‡∑ê‡∂≠'}</i></td><td></td></tr>
            <tr><td><b>‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂±‡∑î ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑Å‡∑ö‡∑Ç‡∂∫</b></td><td style="text-align:right; border-top:1px solid #000; border-bottom:4px double #000;"><b>${(cashBookBal + totalUnpresented).toFixed(2)}</b></td></tr>
            <tr style="background:#f0f0f0;"><td>‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂±‡∂∫‡∑ö ‡∑Å‡∑ö‡∑Ç‡∂∫</td><td style="text-align:right;"><b>${bankStmt.toFixed(2)}</b></td></tr>
        </table>`;
        document.getElementById('rep-body').innerHTML = html;
    }

    function refreshDash() {
        const db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        const projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        let tIn = db.filter(r=>r.type==='IN').reduce((a,b)=>a+b.amt,0) + projs.reduce((a,b)=>a+b.initialAmt,0);
        let tEx = db.filter(r=>r.type==='EX').reduce((a,b)=>a+b.amt,0);
        document.getElementById('dash-stats').innerHTML = `<div class="card" style="border-bottom:5px solid var(--success)"><h4>‡∂∏‡∑î‡∑Ö‡∑î ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä</h4><p class="in-amt">‡∂ª‡∑î. ${tIn.toFixed(2)}</p></div><div class="card" style="border-bottom:5px solid var(--danger)"><h4>‡∂∏‡∑î‡∑Ö‡∑î ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä</h4><p class="ex-amt">‡∂ª‡∑î. ${tEx.toFixed(2)}</p></div><div class="card" style="border-bottom:5px solid var(--accent)"><h4>‡∑Ä‡∂ª‡∑ä‡∂≠‡∂∏‡∑è‡∂± ‡∑Å‡∑ö‡∑Ç‡∂∫</h4><p><b>‡∂ª‡∑î. ${(tIn-tEx).toFixed(2)}</b></p></div>`;
        let fundHtml = '';
        S.forEach(s => {
            let bal = db.filter(r=>r.code===s && r.type==='IN').reduce((a,b)=>a+b.amt,0) - db.filter(r=>r.source===s && r.type==='EX').reduce((a,b)=>a+b.amt,0);
            fundHtml += `<div style="background:#fff; padding:10px; border-radius:8px; border:1px solid #ddd; border-left:4px solid var(--accent)"><small>${s}</small><br><b>${bal.toFixed(2)}</b></div>`;
        });
        document.getElementById('dash-fund-grid').innerHTML = fundHtml;
    }

    function addProject() {
        if(sessionStorage.getItem('role') === 'guest') return;
        const name = document.getElementById('pName').value;
        const amt = parseFloat(document.getElementById('pAmt').value || 0);
        const date = document.getElementById('pDate').value;
        if(!name || amt <= 0) return alert("‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.");
        let projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        projs.push({ id: 'pj_'+Date.now(), name, initialAmt: amt, date });
        localStorage.setItem('sch_projs', JSON.stringify(projs));
        syncToCloud(); location.reload();
    }

    function renderProjectList() {
        const projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        const db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        let html = '<table><tr><th>‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫</th><th>‡∂Ω‡∑ê‡∂∂‡∑î‡∂´‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω</th><th>‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä</th><th>‡∑Å‡∑ö‡∑Ç‡∂∫</th></tr>';
        projs.forEach(p => {
            let e = db.filter(r=>r.proj===p.name).reduce((a,b)=>a+b.amt,0);
            html += `<tr><td>${p.name}</td><td>${p.initialAmt.toFixed(2)}</td><td class="ex-amt">${e.toFixed(2)}</td><td><b>${(p.initialAmt-e).toFixed(2)}</b></td></tr>`;
        });
        document.getElementById('projectListTable').innerHTML = html + '</table>';
    }
</script>
</body>
</html>
