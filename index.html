<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <title>‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ - ‡∂∏‡∑ú/‡∂ú‡∂∏‡∑ä‡∂¥‡∂Ç‡∂ú‡∑î‡∑Ä ‡∂ö‡∂±‡∑í‡∑Ç‡∑ä‡∂® ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂Ω‡∂∫</title>
    <style>
        :root { 
            --primary: #1a252f; --secondary: #2c3e50; --accent: #2980b9;
            --success: #27ae60; --danger: #c0392b; --light: #f4f7f6; --project: #8e44ad;
            --gold: #f1c40f;
        }
        body { font-family: 'Segoe UI', 'Iskoola Pota', Arial, sans-serif; margin: 0; display: flex; background: var(--light); flex-direction: column; }
        
        #login-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: var(--primary);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box { background: white; padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }

        .top-header { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; padding: 30px 20px; text-align: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 101;
        }
        /* ‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂±‡∂∏ ‡∑Ä‡∑í‡∑Å‡∑è‡∂Ω ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ */
        .top-header h1 { margin: 0; font-size: 42px; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .top-header h2 { margin: 10px 0 0; font-size: 24px; font-weight: 300; color: #ecf0f1; }

        .app-container { display: none; width: 100%; }

        .sidebar { width: 280px; height: calc(100vh - 100px); background: var(--primary); color: white; position: fixed; top: 125px; padding-top: 10px; box-shadow: 2px 0 10px rgba(0,0,0,0.3); z-index: 100; overflow-y: auto; }
        .nav-link { padding: 12px 20px; display: block; color: #bdc3c7; text-decoration: none; cursor: pointer; transition: 0.3s; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .nav-link:hover, .nav-link.active { background: var(--secondary); color: white; border-left: 5px solid var(--accent); }

        .main-content { margin-left: 280px; padding: 40px; width: calc(100% - 280px); margin-top: 60px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        .row { display: flex; gap: 20px; margin-bottom: 15px; }
        .field { flex: 1; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #444; font-size: 13px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box; background: #fafafa; }
        
        button { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-save { background: var(--success); color: white; width: 100%; }
        .btn-proj { background: var(--project); color: white; width: 100%; }
        .btn-print { background: var(--accent); color: white; margin-top: 20px; padding: 10px 30px; }
        .btn-pdf { background: #555; color: white; margin-top: 20px; padding: 10px 30px; margin-left: 10px; }
        .btn-del { background: #e74c3c; color: white; padding: 5px 10px; font-size: 11px; border-radius: 4px; border: none; }
        .btn-edit { background: var(--gold); color: black; padding: 5px 10px; font-size: 11px; border-radius: 4px; border: none; margin-right: 5px; }
        .btn-logout { background: #555; color: white; margin: 20px; font-size: 12px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th { background: #f8f9fa; color: var(--primary); padding: 12px; border: 1px solid #dee2e6; text-align: left; font-size: 13px; }
        td { padding: 10px; border: 1px solid #dee2e6; font-size: 13px; }
        
        .in-amt { color: var(--success); font-weight: bold; }
        .ex-amt { color: var(--danger); font-weight: bold; }
        .guest-hide { display: none !important; }
        .staff-hide { display: none !important; }

        .chq-col { width: 85px; font-size: 10px !important; text-align: center; padding: 5px !important; }
        .chq-col input { width: 14px; height: 14px; vertical-align: middle; cursor: pointer; }

        .opening-bal-compact { border-left: 5px solid var(--gold); padding: 15px !important; margin-top: 10px; }
        .opening-bal-compact h4 { margin: 0 0 10px 0; font-size: 14px; }
        .compact-row { display: flex; gap: 10px; align-items: flex-end; }
        .compact-row .field { flex: 1; }
        .compact-row input, .compact-row select { padding: 6px; font-size: 12px; }

        .designer-tag { 
            position: relative; margin-top: 20px; width: 100%; text-align: center; 
            padding: 10px 0; background: rgba(0,0,0,0.2); color: var(--gold); 
            font-weight: bold; font-size: 13px; border-top: 1px solid var(--accent);
        }

        .footer-note { text-align: center; font-size: 14px; color: var(--primary); margin-top: 30px; font-weight: bold; padding: 20px; border-top: 2px solid var(--accent); }
        #sync-status { font-size: 11px; color: #f1c40f; padding: 5px 25px; }

        .filter-box { background: #eef2f3; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #d1d8e0; }

        /* Guide Styles */
        .guide-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .guide-card { border-radius: 8px; border: 1px solid #ddd; overflow: hidden; }
        .guide-head { padding: 10px; color: white; font-weight: bold; text-align: center; }
        .guide-table { width: 100%; font-size: 12px; border: none; margin-top: 0; }
        .guide-table tr:nth-child(even) { background: #f9f9f9; }
        .guide-table td { border: none; border-bottom: 1px solid #eee; }
        .c-badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-weight: bold; color: #333; }

        @media print { 
            .sidebar, button, .no-print, .designer-tag, .btn-del, .btn-edit, input[type="checkbox"], .filter-box { display: none !important; }
            .main-content { margin-left: 0; width: 100%; padding: 0; margin-top: 0; }
            .top-header { background: white !important; color: black !important; border-bottom: 2px solid black; }
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color: var(--primary)">‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∂ß ‡∂á‡∂≠‡∑î‡∑Ö‡∑î ‡∑Ä‡∑ì‡∂∏</h2>
        <input type="password" id="passInput" placeholder="‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±" style="margin-bottom: 15px; text-align: center;">
        <button class="btn-save" onclick="checkLogin()">‡∂á‡∂≠‡∑î‡∑Ö‡∑î ‡∑Ä‡∂±‡∑ä‡∂±</button>
        <p style="font-size: 11px; color: #666; margin-top: 10px;">‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö ‡∂Ö‡∂±‡∑î‡∂∏‡∑ê‡∂≠‡∑í‡∂∫ ‡∂∏‡∂≠ ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂±‡∑ä‡∂±.</p>
    </div>
</div>

<div class="top-header">
    <h1>‡∂∏‡∑ú/‡∂ú‡∂∏‡∑ä‡∂¥‡∂Ç‡∂ú‡∑î‡∑Ä ‡∂ö‡∂±‡∑í‡∑Ç‡∑ä‡∂® ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂Ω‡∂∫</h1>
    <h2>‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∂´ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫</h2>
</div>

<div class="app-container" id="appBody">
    <div class="sidebar no-print">
        <div id="sync-status">‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...</div>
        <a class="nav-link active" onclick="showSec('dash')">üìä ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂¥‡∑î‡∑Ä‡∂ª‡∑î‡∑Ä</a>
        <a class="nav-link admin-only staff-only" id="nav-entry" onclick="showSec('entry')">üìù ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏</a>
        <a class="nav-link admin-only staff-only" id="nav-projects" onclick="showSec('projects')">üèóÔ∏è ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í</a>
        <a class="nav-link" onclick="prepareReport('cash')">üìñ ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑ú‡∂≠</a>
        <a class="nav-link" onclick="prepareReport('fund')">üí∞ ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫</a>
        <a class="nav-link" onclick="prepareReport('exp_sum')">üí∏ ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫</a>
        <a class="nav-link" onclick="prepareReport('code_wise')">üîç ‡∂ö‡∑ö‡∂≠ ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è</a>
        <a class="nav-link" onclick="prepareReport('proj_rep')">üìã ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä</a>
        <a class="nav-link" onclick="prepareReport('recon')">üè¶ ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏</a>
        <a class="nav-link" onclick="showSec('guide')">üìò ‡∂ö‡∑ö‡∂≠ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</a>
        
        <button class="btn-logout" onclick="logout()">‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑ä ‡∂â‡∑Ä‡∂≠‡∑ä ‡∑Ä‡∂±‡∑ä‡∂± (Logout)</button>
        <div class="designer-tag">‡∂±‡∑í‡∂ª‡∑ä‡∂∏‡∑è‡∂´‡∂∫: ‡∂≠‡∂ª‡∂Ç‡∂ú ‡∑Ä‡∑í‡∂¢‡∑ö‡∑É‡∑í‡∂Ç‡∑Ñ</div>
    </div>

    <div class="main-content">
        <div id="sec-dash" class="section">
            <h3>‡∑Ä‡∂≠‡∑ä‡∂∏‡∂±‡∑ä ‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫ <span id="user-role-lbl" style="font-size:12px; color:var(--accent)"></span></h3>
            <div id="dash-stats" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:20px;"></div>
            <div class="card">
                <h4>‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∑Ñ‡∑è ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑Å‡∑ö‡∑Ç‡∂∫‡∂±‡∑ä</h4>
                <div id="dash-fund-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:10px;"></div>
            </div>
        </div>

        <div id="sec-entry" class="section" style="display:none;">
            <div class="row">
                <div class="card field">
                    <h3 class="in-amt">‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä (Receipts)</h3>
                    <div class="row"><div class="field"><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="inDate"></div><div class="field"><label>‡∂Ω‡∂Ø‡∑î‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</label><input type="text" id="inRef"></div></div>
                    <div class="row"><div class="field"><label>‡∂ö‡∑ö‡∂≠‡∂∫</label><select id="inCode"></select></div><div class="field"><label>‡∂∏‡∑î‡∂Ø‡∂Ω</label><input type="number" id="inAmt"></div></div>
                    <label>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</label><textarea id="inDesc" rows="2" style="margin-bottom:15px;"></textarea>
                    <button class="btn-save" onclick="addTx('IN')">‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏ ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
                </div>
                <div class="card field">
                    <h3 class="ex-amt">‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä (Payments)</h3>
                    <div class="row"><div class="field"><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="exDate"></div><div class="field"><label>‡∑Ä‡∑Ä‡∑î‡∂†‡∂ª‡∂∫</label><input type="text" id="exRef"></div></div>
                    <div class="row"><div class="field"><label>‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫</label><select id="exCode"></select></div><div class="field"><label>‡∂∏‡∑î‡∂Ø‡∂Ω</label><input type="number" id="exAmt"></div></div>
                    <div class="row"><div class="field"><label>‡∂∏‡∑ñ‡∂Ω‡∑è‡∑Å‡∑ä‚Äç‡∂ª‡∂∫</label><select id="exSource"></select></div><div class="field"><label>‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫</label><select id="exProjLink"></select></div></div>
                    <div class="row"><div class="field"><label>‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</label><input type="text" id="exCheque"></div></div>
                    <label>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</label><textarea id="exDesc" rows="2" style="margin-bottom:15px;"></textarea>
                    <button class="btn-save" style="background:var(--danger)" onclick="addTx('EX')">‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
                </div>
            </div>

            <div class="card admin-only opening-bal-compact">
                <h4>‡∑Ä‡∂ª‡∑ä‡∑Ç‡∂∫ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫‡∂±‡∑ä</h4>
                <div class="compact-row">
                    <div class="field"><label>‡∂ö‡∑ö‡∂≠‡∂∫</label><select id="openCode"></select></div>
                    <div class="field"><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="openDate"></div>
                    <div class="field"><label>‡∑Å‡∑ö‡∑Ç‡∂∫</label><input type="number" id="openAmt"></div>
                    <div class="field"><button class="btn-save" style="background:var(--gold); color:black; padding: 7px;" onclick="addOpeningBal()">‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button></div>
                </div>
            </div>

            <div class="card admin-only staff-only" style="margin-top: 20px;">
                <h3 style="color: var(--accent);">‡∂Ö‡∑Ä‡∑É‡∑è‡∂± ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä 5</h3>
                <div id="recent-transactions-list"></div>
            </div>
        </div>

        <div id="sec-projects" class="section" style="display:none;">
            <div class="card admin-only staff-only">
                <h3>‡∂±‡∑Ä ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫‡∂ö‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏</h3>
                <input type="hidden" id="editProjectId">
                <div class="row">
                    <div class="field"><label>‡∂±‡∂∏</label><input type="text" id="pName"></div>
                    <div class="field"><label>‡∂ö‡∑ö‡∂≠‡∂∫ (Income Code)</label><select id="pIncomeCode"></select></div>
                    <div class="field"><label>‡∂Ω‡∑ê‡∂∂‡∑î‡∂´‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω</label><input type="number" id="pAmt"></div>
                    <div class="field"><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="pDate"></div>
                    <div class="field" style="align-self:flex-end;">
                        <button class="btn-proj" id="btnProjectAction" onclick="addProject()">‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
                    </div>
                </div>
            </div>
            <div class="card"><div id="projectListTable"></div></div>
        </div>

        <div id="sec-report" class="section" style="display:none;">
            <div class="card">
                <h2 id="rep-title" style="text-align:center;">‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä</h2>
                
                <div id="filter-area" class="filter-box no-print">
                    <div class="row">
                        <div class="field date-filter"><label>‡∑É‡∑í‡∂ß (From)</label><input type="date" id="fDate"></div>
                        <div class="field date-filter"><label>‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è (To)</label><input type="date" id="tDate"></div>
                        <div id="code-filter-field" class="field" style="display:none;">
                            <label>‡∂ö‡∑ö‡∂≠‡∂∫ ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±</label><select id="filterCodeSelect"></select>
                        </div>
                        <div class="field" style="align-self:flex-end;">
                            <button class="btn-save" style="width:auto; padding:10px 25px;" onclick="runFilteredReport()">‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
                        </div>
                    </div>
                </div>

                <div id="recon-inputs" class="no-print" style="display:none; background:#f9f9f9; padding:15px; margin-bottom:20px; border-radius:8px;">
                    <label>‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂±‡∂∫‡∑ö ‡∑Å‡∑ö‡∑Ç‡∂∫ (Bank Statement Balance):</label>
                    <input type="number" id="bankStatementAmt" style="width:200px; display:inline-block; margin:10px 0;">
                    <button class="btn-save" style="width:auto; padding:8px 20px;" onclick="calculateRecon()">‡∑É‡∑ê‡∑É‡∂Ø‡∑î‡∂∏ ‡∑É‡∑è‡∂Ø‡∂±‡∑ä‡∂±</button>
                </div>

                <div id="rep-body"></div>
                <button class="btn-print no-print" onclick="window.print()">‡∂∏‡∑î‡∂Ø‡∑ä‚Äç‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Print)</button>
                <button class="btn-pdf no-print" onclick="window.print()">PDF ‡∂Ω‡∑ô‡∑É ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
                <div class="footer-note">‡∂±‡∑í‡∂ª‡∑ä‡∂∏‡∑è‡∂´‡∂∫ ‡∑Ñ‡∑è ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´‡∂∫:‡∂≠‡∂ª‡∂Ç‡∂ú ‡∑Ä‡∑í‡∂¢‡∑ö‡∑É‡∑í‡∂Ç‡∑Ñ-0777944308</div>
            </div>
        </div>

        <div id="sec-guide" class="section" style="display:none;">
            <div class="card">
                <h3 style="color: var(--primary); text-align: center; border-bottom: 2px solid var(--accent); padding-bottom: 10px;">üìò ‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í ‡∂ö‡∑ö‡∂≠ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂∏‡∑è‡∂ª‡∑ä‡∂ú‡∑ù‡∂¥‡∂Ø‡∑ö‡∑Å‡∂∫</h3>
                <div class="guide-grid">
                    <div class="guide-card">
                        <div class="guide-head" style="background: var(--success);">‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠ (Income Codes)</div>
                        <table class="guide-table">
                            <tr><td><span class="c-badge">S1</span></td><td>‡∂í‡∂ö‡∑è‡∂∂‡∂Ø‡∑ä‡∂∞ ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∑É‡∑Ñ ‡∂¥‡∑Ö‡∑è‡∂≠‡∑ä ‡∑É‡∂∑‡∑è ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä</td></tr>
                            <tr><td><span class="c-badge">S2</span></td><td>‡∑É‡∑Ñ‡∂∫‡∑ù‡∂ú‡∑í‡∂≠‡∑è ‡∂ú‡∑í‡∑Ä‡∑í‡∑É‡∑î ‡∂∫‡∂ß‡∂≠‡∑ö ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∂± ‡∑Ä‡∑ê‡∂©‡∑É‡∂ß‡∑Ñ‡∂± ‡∑Ñ‡∑è ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑É‡∂Ø‡∑Ñ‡∑è ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä</td></tr>
                            <tr><td><span class="c-badge">S3</span></td><td>‡∂ª‡∂¢‡∂∫‡∑ö ‡∂Ü‡∂∞‡∑è‡∂ª</td></tr>
                            <tr><td><span class="c-badge">S4</span></td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∂¥‡∑è‡∂Ø‡∂ö ‡∂â‡∂ú‡∑ô‡∂±‡∑î‡∂∏‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∂ª‡∑ä‡∂Ø‡∂± ‡∂¥‡∑ä‚Äç‡∂ª‡∂Ø‡∑è‡∂±‡∂∫‡∂±‡∑ä , ‡∂ú‡∑î‡∂´‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂∫‡∑ô‡∂Ø‡∑Ä‡∑î‡∂∏‡∑ä ‡∑Ñ‡∑è ‡∂ã‡∑É‡∑É‡∑ä ‡∂∏‡∂ß‡∑ä‡∂ß‡∂∏‡∑ö ‡∂â‡∂ú‡∑ô‡∂±‡∑î‡∂∏‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í ‡∑É‡∂Ø‡∑Ñ‡∑è ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä</td></tr>
                            <tr><td><span class="c-badge">S5</span></td><td>‡∂ª‡∂¢‡∂∫ ‡∑Ä‡∑í‡∑É‡∑í‡∂±‡∑ä ‡∂Ö‡∂±‡∑î‡∂∏‡∂≠ ‡∑Ñ‡∑è ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∂ª‡∑è‡∂¢‡∑ä‚Äç‡∂∫ ‡∂±‡∑ú‡∑Ä‡∂± ‡∑É‡∂Ç‡∑Ä‡∑í‡∂∞‡∑è‡∂± ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂Ü‡∂∞‡∑è‡∂ª</td></tr>
                            <tr><td><span class="c-badge">S6</span></td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î‡∑Ä ‡∑Ä‡∑ô‡∂±‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∑É‡∑ä‡∑Ä ‡∂ö‡∑ê‡∂∏‡∑ê‡∂≠‡∑ä‡∂≠‡∑ô‡∂±‡∑ä ‡∂Ø‡∂∫‡∂ö‡∂≠‡∑ä‡∑Ä‡∂∫ ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂± ‡∂ï‡∂±‡∑ë‡∂∏ ‡∂¥‡∑è‡∂ª‡∑ä‡∑Å‡∑Ä‡∂∫‡∂ö ‡∂¥‡∂ª‡∑í‡∂≠‡∑ä‚Äç‡∂∫‡∂ú</td></tr>
                            <tr><td><span class="c-badge">S7</span></td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∂ß ‡∂Ö‡∂∫‡∂≠‡∑ä ‡∑Ä‡∂≠‡∑ä‡∂ö‡∂∏‡∑ä ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä ‡∂ã‡∂¥‡∂∫‡∑è ‡∂ú‡∂±‡∑ä‡∂±‡∑è ‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏‡∑ä</td></tr>
                            <tr><td><span class="c-badge">S8</span></td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∑É‡∂Ç‡∑Ä‡∂ª‡∑ä‡∂∞‡∂± ‡∑É‡∂∏‡∑í‡∂≠‡∑í ‡∑É‡∑è‡∂∏‡∑è‡∂¢‡∑í‡∂ö ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä</td></tr>
                            <tr><td><span class="c-badge">S9</span></td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂â‡∂ú‡∑ô‡∂±‡∑î‡∂∏‡∑ä ‡∂â‡∂ú‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í‡∂∫‡∂ß ‡∂Ö‡∂Ø‡∑è‡∂Ω ‡∂Ö‡∂≠‡∑ä‚Äç‡∂∫‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∂ö‡∂∏‡∑ä ‡∑É‡∂Ø‡∑Ñ‡∑è ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä</td></tr>
                            <tr><td><span class="c-badge">S10</span></td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∑É‡∂Ç‡∑Ä‡∂ª‡∑ä‡∂∞‡∂± ‡∑É‡∂∏‡∑í‡∂≠‡∑í‡∂∫ ‡∂∏‡∂ú‡∑í‡∂±‡∑ä ‡∂≠‡∑ì‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂´‡∑î ‡∂Ω‡∂∂‡∂± ‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂Ö‡∂≠‡∑ä‚Äç‡∑Ä‡∑Å ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂¥‡∑í‡∂∫‡∑Ä‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ ‡∑É‡∂Ø‡∑Ñ‡∑è ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä </td></tr>
                        </table>
                    </div>
                    <div class="guide-card">
                        <div class="guide-head" style="background: var(--danger);">‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠ (Expenditure Codes)</div>
                        <table class="guide-table">
                            <tr><td><span class="c-badge">REx1</span></td><td>‡∑Ä‡∑í‡∑Ç‡∂∫ ‡∂∏‡∑è‡∂Ω‡∑è ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∂Ø‡∑è‡∂Ω ‡∂¥‡∑î‡∂±‡∂ª‡∑è‡∑Ä‡∂ª‡∑ä‡∂≠‡∂± ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä</td></tr>
                            <tr><td><span class="c-badge">REx2</span></td><td>‡∂ã‡∂¥‡∂Ø‡∑ö‡∑Å‡∂± , ‡∂ã‡∑É‡∑É‡∑ä ‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂± ‡∑Ñ‡∑è ‡∑Ä‡∑í‡∑Ç‡∂∫ ‡∑É‡∂∏‡∂ú‡∑è‡∂∏‡∑ì ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∂ö‡∂∏‡∑ä</td></tr>
                            <tr><td><span class="c-badge">REx3</span></td><td>‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂± ‡∂¥‡∂ª‡∑í‡∂¥‡∑è‡∂Ω‡∂± ‡∑Ñ‡∑è ‡∂ã‡∂¥‡∂∫‡∑ù‡∂ú‡∑í‡∂≠‡∑è  ‡∑É‡∑ö‡∑Ä‡∑è ‡∑Ñ‡∑è ‡∑Å‡∑î‡∂∑‡∑É‡∑è‡∂∞‡∂± ‡∂ö‡∂ß‡∂∫‡∑î‡∂≠‡∑î</td></tr>
                            <tr><td><span class="c-badge">REx4</span></td><td>‡∂ö‡∑è‡∂ª‡∑ä‡∂∫ ‡∂∏‡∂´‡∑ä‡∂©‡∂Ω ‡∂¥‡∑è‡∂ª‡∑í‡∑Å‡∑ä‚Äç‡∂ª‡∂∏‡∑í‡∂ö</td></tr>
                            <tr><td><span class="c-badge">REx5</span></td><td>‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∂∑‡∑è‡∂´‡∑ä‡∂© ‡∑Ñ‡∑è ‡∂ã‡∂¥‡∂ö‡∂ª‡∂´ ‡∂±‡∂©‡∂≠‡∑ä‡∂≠‡∑î/‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è</td></tr>
                            <tr><td><span class="c-badge">REx6</span></td><td>‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂ú‡∑ú‡∂©‡∂±‡∑ê‡∂ú‡∑í‡∂Ω‡∑í ‡∑É‡∑î‡∑Ö‡∑î ‡∂±‡∂©‡∂≠‡∑ä‡∂≠‡∑î/‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è</td></tr>
                            <tr><td><span class="c-badge">REx7</span></td><td>‡∂¥‡∑Ä‡∑í‡∂≠‡∑ä‚Äç‡∂ª‡∂≠‡∑è ‡∑Ñ‡∑è ‡∂¥‡∑í‡∂ª‡∑í‡∑É‡∑í‡∂Ø‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä</td></tr>
                            <tr><td><span class="c-badge">CEx1</span></td><td>‡∂∏‡∑ñ‡∂Ω‡∑í‡∂ö ‡∂¥‡∑Ñ‡∑É‡∑î‡∂ö‡∂∏‡∑ä - ‡∂±‡∑Ä ‡∑É‡∑ê‡∂¥‡∂∫‡∑ì‡∂∏‡∑ä</td></tr>
                            <tr><td><span class="c-badge">CEx2</span></td><td>‡∑Ä‡∑í‡∑Ç‡∂∫ ‡∂∏‡∑è‡∂Ω‡∑è ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∂Ø‡∑è‡∂Ω ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä</td></tr>
                            <tr><td><span class="c-badge">CEx3</span></td><td>‡∂¥‡∑î‡∑É‡∑ä‡∂≠‡∂ö‡∑è‡∂Ω ‡∂¥‡∑ú‡∂≠‡∑ä ‡∂∏‡∑í‡∂Ω‡∂ß ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ä</td></tr>
                            <tr><td><span class="c-badge">CEx4</span></td><td>‡∂ú‡∑ú‡∂©‡∂±‡∑ê‡∂ú‡∑í‡∂Ω‡∑í  ‡∂±‡∑Ä ‡∂â‡∂Ø‡∑í‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä, ‡∑Ä‡∑ê‡∂©‡∑í‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä ‡∑Ñ‡∑è ‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä</td></tr>
                            <tr><td><span class="c-badge">CEx5</span></td><td>‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∂ã‡∂¥‡∂ö‡∂ª‡∂´ ‡∂∏‡∑í‡∂Ω‡∂ß ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ä</td></tr>
                            <tr><td><span class="c-badge">CEx6</span></td><td>‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑É‡∂Ø‡∑Ñ‡∑è ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∂Ü‡∂∞‡∑è‡∂ª</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwuT7SdENJsFlXTf7o_tV2l20d-iu3K9IlRLYex6GYx9zT_RKLw9qtJv-1fKQL2NUVJ/exec";
    
    // Passwords for 3 user levels
    const PASSWORDS = {
        admin: "Tharanga",  // Super User
        staff: "Staff123",  // Data Entry (Can Add, cannot delete/edit)
        guest: "Guest"      // View Only
    };

    const S = ["S1", "S2", "S3", "S4", "S5", "S6", "S7", "S8", "S9", "S10"];
    const EX = ["REx1", "REx2", "REx3", "REx4", "REx5", "REx6", "REx7", "CEx1", "CEx2", "CEx3", "CEx4", "CEx5", "CEx6"];

    let currentReportType = '';

    window.onload = () => { if(sessionStorage.getItem('isLogged')) unlockApp(); };

    function checkLogin() {
        let p = document.getElementById('passInput').value;
        if(p === PASSWORDS.admin) { sessionStorage.setItem('isLogged', 't'); sessionStorage.setItem('role', 'admin'); unlockApp(); }
        else if(p === PASSWORDS.staff) { sessionStorage.setItem('isLogged', 't'); sessionStorage.setItem('role', 'staff'); unlockApp(); }
        else if(p === PASSWORDS.guest) { sessionStorage.setItem('isLogged', 't'); sessionStorage.setItem('role', 'guest'); unlockApp(); }
        else alert("‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í!");
    }

    function logout() {
        sessionStorage.clear();
        location.reload();
    }

    function unlockApp() {
        let role = sessionStorage.getItem('role');
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('appBody').style.display = 'flex';
        
        let roleName = "‡∂∂‡∑ê‡∂Ω‡∑ì‡∂∏‡∂ß ‡∂¥‡∂∏‡∂´‡∑í";
        if(role==='admin') roleName = "‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∑î (Admin)";
        if(role==='staff') roleName = "‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±‡∑è (Staff)";
        document.getElementById('user-role-lbl').innerText = `(${roleName})`;

        // Visual Permissions
        if(role === 'guest') {
            document.getElementById('nav-entry').style.display = 'none';
            document.getElementById('nav-projects').style.display = 'none';
        } else {
            document.getElementById('nav-entry').style.display = 'block';
            document.getElementById('nav-projects').style.display = 'block';
        }
        
        setupDrops(); refreshDash(); syncFromCloud();
    }

    async function syncToCloud() {
        if(sessionStorage.getItem('role') === 'guest') return;
        document.getElementById('sync-status').innerText = "‡∑É‡∑î‡∂ª‡∑ê‡∂ö‡∑ô‡∂∏‡∑í‡∂±‡∑ä...";
        const data = { db: localStorage.getItem('sch_db'), projs: localStorage.getItem('sch_projs') };
        try { await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) }); document.getElementById('sync-status').innerText = "Cloud ‡∑É‡∂∏‡∂ú ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞‡∂∫‡∑í ‚úÖ"; }
        catch(e) { document.getElementById('sync-status').innerText = "Sync ‡∂Ö‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í ‚ö†Ô∏è"; }
    }

    async function syncFromCloud() {
        try {
            const res = await fetch(GOOGLE_SCRIPT_URL);
            const cloudData = await res.json();
            if(cloudData.db) localStorage.setItem('sch_db', cloudData.db);
            if(cloudData.projs) localStorage.setItem('sch_projs', cloudData.projs);
            setupDrops(); refreshDash();
        } catch(e) { console.log("Cloud sync error."); }
    }

    function setupDrops() {
        const inC = document.getElementById('inCode');
        const exC = document.getElementById('exCode');
        const exS = document.getElementById('exSource');
        const opC = document.getElementById('openCode');
        const filC = document.getElementById('filterCodeSelect');
        const pIncC = document.getElementById('pIncomeCode');

        const sOptions = S.map(c => `<option>${c}</option>`).join('');
        inC.innerHTML = sOptions;
        exC.innerHTML = EX.map(c => `<option>${c}</option>`).join('');
        exS.innerHTML = sOptions;
        opC.innerHTML = sOptions;
        pIncC.innerHTML = sOptions;
        filC.innerHTML = '<optgroup label="‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä">' + S.map(c => `<option value="${c}">${c}</option>`).join('') + '</optgroup>' + 
                         '<optgroup label="‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä">' + EX.map(c => `<option value="${c}">${c}</option>`).join('') + '</optgroup>';

        const projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        document.getElementById('exProjLink').innerHTML = '<option value="">-- ‡∂±‡∑ê‡∂≠ --</option>' + projs.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        renderProjectList();
        renderRecentTransactions();
    }

    function showSec(id) {
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.getElementById('sec-' + id).style.display = 'block';
    }

    function addOpeningBal() {
        if(sessionStorage.getItem('role') !== 'admin') return;
        const code = document.getElementById('openCode').value;
        const amt = parseFloat(document.getElementById('openAmt').value || 0);
        const date = document.getElementById('openDate').value;
        if(!date || amt < 0) return alert("‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.");
        const d = { id: 'open_' + Date.now(), type: 'IN', date, ref: 'OP-BAL', code, amt, desc: '‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫ (' + code + ')', source: code, cheque: '-', proj: '', realized: true };
        let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        db.push(d); localStorage.setItem('sch_db', JSON.stringify(db));
        syncToCloud(); refreshDash(); renderRecentTransactions(); alert("‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫ ‡∑É‡∑î‡∂ª‡∑ê‡∂ö‡∑î‡∂´‡∑í.");
    }

    function addTx(type) {
        const role = sessionStorage.getItem('role');
        if(role === 'guest') return;
        
        const p = type === 'IN' ? 'in' : 'ex';
        const amtInput = document.getElementById(p+'Amt');
        const dateInput = document.getElementById(p+'Date');
        const codeInput = document.getElementById(p+'Code');
        
        const amt = parseFloat(amtInput.value || 0);
        const date = dateInput.value;
        const code = codeInput.value;

        if(!date || amt <= 0 || !code) {
            alert("‡∂Ö‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂Ø‡∂≠‡∑ä‡∂≠: ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂Ø‡∑í‡∂±‡∂∫, ‡∂ö‡∑ö‡∂≠‡∂∫ ‡∑É‡∑Ñ ‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∑Ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.");
            return;
        }

        const d = {
            id: 'tx_' + Date.now(), type, date, ref: document.getElementById(p+'Ref').value,
            code, amt, desc: document.getElementById(p+'Desc').value,
            source: type==='EX'?document.getElementById('exSource').value:code,
            cheque: type==='EX'?document.getElementById('exCheque').value:'-',
            proj: type==='EX' ? document.getElementById('exProjLink').value : '',
            realized: true 
        };
        let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        db.push(d); localStorage.setItem('sch_db', JSON.stringify(db));
        syncToCloud(); 
        amtInput.value = ''; document.getElementById(p+'Ref').value = ''; document.getElementById(p+'Desc').value = '';
        refreshDash(); renderRecentTransactions(); alert("‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∑É‡∑î‡∂ª‡∑ê‡∂ö‡∑î‡∂´‡∑í.");
    }

    function renderRecentTransactions() {
        let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        let recent = db.filter(r => !r.id.startsWith('open')).slice(-5).reverse();
        const role = sessionStorage.getItem('role');
        
        let html = '<table><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä</th></tr>';
        recent.forEach(r => {
            let actionBtns = '';
            if(role === 'admin') {
                actionBtns = `<button class="btn-edit" onclick="editTx('${r.id}')">‡∑É‡∂Ç‡∑Å‡∑ù‡∂∞‡∂±‡∂∫</button><button class="btn-del" onclick="deleteTx('${r.id}')">‡∂∏‡∂ö‡∂±‡∑ä‡∂±</button>`;
            } else {
                actionBtns = `<span style="font-size:10px; color:gray">‡∂Ö‡∑Ä‡∑É‡∂ª ‡∂±‡∑ê‡∂≠ (Admin Only)</span>`;
            }
            html += `<tr><td>${r.date}</td><td>${r.code}</td><td class="${r.type==='IN'?'in-amt':'ex-amt'}">${r.amt.toFixed(2)}</td><td>${r.desc}</td><td>${actionBtns}</td></tr>`;
        });
        document.getElementById('recent-transactions-list').innerHTML = html + '</table>';
    }

    function editTx(id) {
        if(sessionStorage.getItem('role') !== 'admin') return alert("‡∑É‡∂Ç‡∑Å‡∑ù‡∂∞‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑É‡∂ª ‡∂á‡∂≠‡∑ä‡∂≠‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∑î‡∂ß ‡∂¥‡∂∏‡∂´‡∑í.");
        let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        let tx = db.find(r => r.id === id);
        if(!tx) return;
        if(confirm("‡∂∏‡∑ô‡∂∏ ‡∂Ø‡∂≠‡∑ä‡∂≠‡∂∫ ‡∑É‡∂Ç‡∑Å‡∑ù‡∂∞‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂Ø?")) {
            const p = tx.type === 'IN' ? 'in' : 'ex';
            document.getElementById(p+'Date').value = tx.date;
            document.getElementById(p+'Ref').value = tx.ref;
            document.getElementById(p+'Code').value = tx.code;
            document.getElementById(p+'Amt').value = tx.amt;
            document.getElementById(p+'Desc').value = tx.desc;
            deleteTx(id, false); window.scrollTo(0,0);
        }
    }

    function deleteTx(id, ask = true) {
        if(sessionStorage.getItem('role') !== 'admin') return alert("‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂∏‡∂ö‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑É‡∂ª ‡∂á‡∂≠‡∑ä‡∂≠‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∑î‡∂ß ‡∂¥‡∂∏‡∂´‡∑í.");
        if(ask && !confirm("‡∂∏‡∂ö‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏‡∂ß ‡∂î‡∂∂ ‡∑É‡∑ä‡∂Æ‡∑í‡∂ª‡∂Ø?")) return;
        let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        db = db.filter(r => r.id !== id);
        localStorage.setItem('sch_db', JSON.stringify(db));
        syncToCloud(); refreshDash(); renderRecentTransactions();
    }

    function prepareReport(type) {
        currentReportType = type;
        showSec('report');
        if (type === 'recon' || type === 'proj_rep') {
            document.getElementById('filter-area').style.display = 'none';
        } else {
            document.getElementById('filter-area').style.display = 'block';
        }
        document.getElementById('code-filter-field').style.display = (type === 'code_wise') ? 'block' : 'none';
        document.getElementById('recon-inputs').style.display = (type === 'recon') ? 'block' : 'none';
        runFilteredReport();
    }

    function runFilteredReport() {
        const fromDate = document.getElementById('fDate').value;
        const toDate = document.getElementById('tDate').value;
        const filterCode = document.getElementById('filterCodeSelect').value;
        runReport(currentReportType, fromDate, toDate, filterCode);
    }

    function runReport(type, from = '', to = '', codeFilter = '') {
        let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        const projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        const role = sessionStorage.getItem('role');
        if(type !== 'recon' && type !== 'proj_rep') {
            if(from) db = db.filter(r => r.date >= from);
            if(to) db = db.filter(r => r.date <= to);
        }
        let html = '', title = '';
        if(type === 'recon') {
            title = "‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏"; 
            document.getElementById('rep-body').innerHTML = "‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂±‡∂∫‡∑ö ‡∑Å‡∑ö‡∑Ç‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª ‡∂∂‡∑ú‡∂≠‡∑ä‡∂≠‡∂∏ ‡∂î‡∂∂‡∂±‡∑ä‡∂±.";
        } else if(type === 'cash') {
            title = "‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑ú‡∂≠";
            html = `<table><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä (+)</th><th>‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä (-)</th><th>‡∑Å‡∑ö‡∑Ç‡∂∫</th><th class="chq-col">‡∂±‡∑í‡∑Ç‡∑ä‡∂ö‡∑è‡∑Å‡∂´‡∂∫ ‡∑Ä‡∑ì‡∂∏</th></tr>`;
            let bal = 0;
            let combined = [...db.map(r=>({...r, isP:false})), ...projs.map(p=>({id:p.id, type:'IN', date:p.date, desc:'‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏: '+p.name, code:p.incomeCode || 'PROJ', amt:p.initialAmt, realized:true}))];
            combined.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(r => {
                bal += (r.type==='IN'?r.amt:-r.amt);
                let check = (r.type==='EX' && r.cheque !== '-') ? `<input type="checkbox" ${r.realized?'checked':''} ${role==='guest'?'disabled':''} onchange="toggleRealized('${r.id}', this.checked)"><br>${r.realized?'‡∂î‡∑Ä‡∑ä':'‡∂±‡∑ê‡∂≠'}` : '-';
                html += `<tr><td>${r.date}</td><td>${r.desc}</td><td>${r.code}</td><td class="in-amt">${r.type==='IN'?r.amt.toFixed(2):'-'}</td><td class="ex-amt">${r.type==='EX'?r.amt.toFixed(2):'-'}</td><td><b>${bal.toFixed(2)}</b></td><td class="chq-col">${check}</td></tr>`;
            });
        } else if(type === 'fund') {
            title = "‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫";
            html = `<table><tr><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä</th><th>‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä</th><th>‡∑Å‡∑ö‡∑Ç‡∂∫</th></tr>`;
            S.forEach(s => {
                let tin = db.filter(r=>r.code===s && r.type==='IN').reduce((a,b)=>a+b.amt,0);
                let projIn = projs.filter(p => p.incomeCode === s).reduce((a,b)=>a+b.initialAmt,0);
                let tout = db.filter(r=>r.source===s && r.type==='EX').reduce((a,b)=>a+b.amt,0);
                html += `<tr><td>${s}</td><td>${(tin + projIn).toFixed(2)}</td><td>${tout.toFixed(2)}</td><td><b>${(tin + projIn - tout).toFixed(2)}</b></td></tr>`;
            });
        } else if(type === 'exp_sum') {
            title = "‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫";
            html = `<table><tr><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω</th></tr>`;
            EX.forEach(c => {
                let a = db.filter(r=>r.type==='EX' && r.code===c).reduce((a,b)=>a+b.amt,0);
                html += `<tr><td>${c}</td><td class="ex-amt">${a.toFixed(2)}</td></tr>`;
            });
        } else if(type === 'proj_rep') {
            title = "‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä";
            projs.forEach(p => {
                let pExpenses = db.filter(r => r.proj === p.name);
                let totalExp = pExpenses.reduce((a,b) => a+b.amt, 0);
                html += `<div style="background:#f9f9f9; padding:15px; border:1px solid #ddd; margin-bottom:20px; border-radius:8px;">`;
                html += `<h4 style="margin:0; color:var(--project)">‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫: ${p.name} (‡∂ö‡∑ö‡∂≠‡∂∫: ${p.incomeCode || 'PROJ'})</h4>`;
                html += `<p style="font-size:13px;">‡∂∏‡∑î‡∑Ö‡∑î ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏: <b>${p.initialAmt.toFixed(2)}</b> | ‡∂∏‡∑î‡∑Ö‡∑î ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏: <b class="ex-amt">${totalExp.toFixed(2)}</b> | ‡∑Å‡∑ö‡∑Ç‡∂∫: <b>${(p.initialAmt - totalExp).toFixed(2)}</b></p>`;
                
                if(pExpenses.length > 0) {
                    html += `<table style="font-size:11px; margin-top:5px;"><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω</th></tr>`;
                    pExpenses.forEach(ex => {
                        html += `<tr><td>${ex.date}</td><td>${ex.desc}</td><td>${ex.code}</td><td class="ex-amt">${ex.amt.toFixed(2)}</td></tr>`;
                    });
                    html += `</table>`;
                } else {
                    html += `<p style="font-size:11px; color:gray italic">‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂∏‡∑ô‡∂≠‡∑ô‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠.</p>`;
                }
                html += `</div>`;
            });
        } else if(type === 'code_wise') {
            title = "‡∂ö‡∑ö‡∂≠‡∂∫ ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä: " + codeFilter;
            html = `<table><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω</th></tr>`;
            db.filter(r => r.code === codeFilter || r.source === codeFilter).forEach(r => {
                html += `<tr><td>${r.date}</td><td>${r.desc}</td><td class="${r.type==='IN'?'in-amt':'ex-amt'}">${r.amt.toFixed(2)}</td></tr>`;
            });
        }
        document.getElementById('rep-title').innerText = title;
        if(type !== 'recon') document.getElementById('rep-body').innerHTML = html + (type !== 'proj_rep' ? "</table>" : "");
    }

    function calculateRecon() {
        const bankStmt = parseFloat(document.getElementById('bankStatementAmt').value || 0);
        const db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        const projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        const cashBookBal = (db.filter(r=>r.type==='IN').reduce((a,b)=>a+b.amt,0) + projs.reduce((a,b)=>a+b.initialAmt,0)) - db.filter(r=>r.type==='EX').reduce((a,b)=>a+b.amt,0);
        const unpresented = db.filter(r => r.type === 'EX' && r.cheque !== '-' && !r.realized);
        const totalUnpresented = unpresented.reduce((a,b) => a+b.amt, 0);
        let html = `<table style="max-width:600px; margin:auto; border:2px solid var(--primary);"><tr><th colspan="2" style="text-align:center;">‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂∫</th></tr><tr><td>‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑ú‡∂≠‡∑ö ‡∑Å‡∑ö‡∑Ç‡∂∫</td><td style="text-align:right;"><b>${cashBookBal.toFixed(2)}</b></td></tr><tr><td>(+) ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î‡∑Ä‡∂ß ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂¥‡∂≠‡∑ä ‡∂±‡∑ú‡∂ö‡∑Ö ‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä</td><td style="text-align:right; color:var(--success)">${totalUnpresented.toFixed(2)}</td></tr><tr><td><b>‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂±‡∑î ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑Å‡∑ö‡∑Ç‡∂∫</b></td><td style="text-align:right; border-top:1px solid #000; border-bottom:4px double #000;"><b>${(cashBookBal + totalUnpresented).toFixed(2)}</b></td></tr><tr style="background:#f0f0f0;"><td>‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂±‡∂∫‡∑ö ‡∑Å‡∑ö‡∑Ç‡∂∫</td><td style="text-align:right;"><b>${bankStmt.toFixed(2)}</b></td></tr></table>`;
        document.getElementById('rep-body').innerHTML = html;
    }

    function toggleRealized(id, status) {
        if(sessionStorage.getItem('role') === 'guest') return;
        let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        let idx = db.findIndex(r => r.id === id);
        if(idx !== -1) { db[idx].realized = status; localStorage.setItem('sch_db', JSON.stringify(db)); syncToCloud(); }
    }

    function refreshDash() {
        const db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        const projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        let tIn = db.filter(r=>r.type==='IN').reduce((a,b)=>a+b.amt,0) + projs.reduce((a,b)=>a+b.initialAmt,0);
        let tEx = db.filter(r=>r.type==='EX').reduce((a,b)=>a+b.amt,0);
        document.getElementById('dash-stats').innerHTML = `<div class="card"><h4>‡∂∏‡∑î‡∑Ö‡∑î ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä</h4><p class="in-amt">‡∂ª‡∑î. ${tIn.toFixed(2)}</p></div><div class="card"><h4>‡∂∏‡∑î‡∑Ö‡∑î ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä</h4><p class="ex-amt">‡∂ª‡∑î. ${tEx.toFixed(2)}</p></div><div class="card"><h4>‡∑Å‡∑ö‡∑Ç‡∂∫</h4><p>‡∂ª‡∑î. ${(tIn-tEx).toFixed(2)}</p></div>`;
        let fundHtml = '';
        S.forEach(s => {
            let tin = db.filter(r=>r.code===s && r.type==='IN').reduce((a,b)=>a+b.amt,0);
            let projIn = projs.filter(p => p.incomeCode === s).reduce((a,b)=>a+b.initialAmt,0);
            let tout = db.filter(r=>r.source===s && r.type==='EX').reduce((a,b)=>a+b.amt,0);
            let bal = (tin + projIn) - tout;
            fundHtml += `<div style="background:#fff; padding:10px; border-radius:8px; border:1px solid #ddd; border-left:4px solid var(--accent)"><small>${s}</small><br><b>${bal.toFixed(2)}</b></div>`;
        });
        document.getElementById('dash-fund-grid').innerHTML = fundHtml;
    }

    function addProject() {
        if(sessionStorage.getItem('role') === 'guest') return;
        const name = document.getElementById('pName').value;
        const amt = parseFloat(document.getElementById('pAmt').value || 0);
        const date = document.getElementById('pDate').value;
        const incCode = document.getElementById('pIncomeCode').value;
        const editId = document.getElementById('editProjectId').value;
        
        if(!name || amt <= 0 || !date) {
            alert("‡∂Ö‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂Ø‡∂≠‡∑ä‡∂≠: ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫‡∑ö ‡∂±‡∂∏, ‡∂Ø‡∑í‡∂±‡∂∫ ‡∑É‡∑Ñ ‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.");
            return;
        }
        
        let projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        
        if(editId) {
            if(sessionStorage.getItem('role') !== 'admin') return alert("‡∑É‡∂Ç‡∑Å‡∑ù‡∂∞‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑É‡∂ª ‡∂á‡∂≠‡∑ä‡∂≠‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∑î‡∂ß ‡∂¥‡∂∏‡∂´‡∑í.");
            let idx = projs.findIndex(p => p.id === editId);
            if(idx !== -1) projs[idx] = { ...projs[idx], name, initialAmt: amt, date, incomeCode: incCode };
            document.getElementById('editProjectId').value = '';
            document.getElementById('btnProjectAction').innerText = '‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±';
        } else {
            projs.push({ id: 'pj_'+Date.now(), name, initialAmt: amt, date, incomeCode: incCode });
        }
        
        localStorage.setItem('sch_projs', JSON.stringify(projs));
        syncToCloud(); setupDrops();
        document.getElementById('pName').value = '';
        document.getElementById('pAmt').value = '';
        document.getElementById('pDate').value = '';
        alert("‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∑Ä‡∑í‡∂∫.");
    }

    function deleteProject(id) {
        if(sessionStorage.getItem('role') !== 'admin') return alert("‡∂∏‡∂ö‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑É‡∂ª ‡∂á‡∂≠‡∑ä‡∂≠‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∑î‡∂ß ‡∂¥‡∂∏‡∂´‡∑í.");
        if(!confirm("‡∂∏‡∑ô‡∂∏ ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫ ‡∂∏‡∂ö‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏‡∂ß ‡∂î‡∂∂ ‡∑É‡∑ä‡∂Æ‡∑í‡∂ª‡∂Ø? ‡∂∏‡∑í‡∂±‡∑ä ‡∂ë‡∂∏ ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂±‡∑ú‡∑Ä‡∂± ‡∂∂‡∑Ä ‡∑É‡∂Ω‡∂ö‡∂±‡∑ä‡∂±.")) return;
        let projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        projs = projs.filter(p => p.id !== id);
        localStorage.setItem('sch_projs', JSON.stringify(projs));
        syncToCloud(); setupDrops();
    }

    function editProject(id) {
        if(sessionStorage.getItem('role') !== 'admin') return alert("‡∑É‡∂Ç‡∑Å‡∑ù‡∂∞‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑É‡∂ª ‡∂á‡∂≠‡∑ä‡∂≠‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∑î‡∂ß ‡∂¥‡∂∏‡∂´‡∑í.");
        let projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        let p = projs.find(x => x.id === id);
        if(!p) return;
        document.getElementById('pName').value = p.name;
        document.getElementById('pAmt').value = p.initialAmt;
        document.getElementById('pDate').value = p.date;
        document.getElementById('pIncomeCode').value = p.incomeCode || 'S1';
        document.getElementById('editProjectId').value = p.id;
        document.getElementById('btnProjectAction').innerText = '‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂±‡∑ä‡∂±';
        window.scrollTo(0,0);
    }

    function renderProjectList() {
        const projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        const db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        const role = sessionStorage.getItem('role');
        let html = '<table><tr><th>‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫</th><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∂Ω‡∑ê‡∂∂‡∑î‡∂´‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω</th><th>‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä</th><th>‡∑Å‡∑ö‡∑Ç‡∂∫</th><th>‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä</th></tr>';
        projs.forEach(p => {
            let e = db.filter(r=>r.proj===p.name).reduce((a,b)=>a+b.amt,0);
            let actionBtns = '';
            if(role === 'admin') {
                actionBtns = `<button class="btn-edit" onclick="editProject('${p.id}')">‡∑É‡∂Ç‡∑Å‡∑ù‡∂∞‡∂±‡∂∫</button><button class="btn-del" onclick="deleteProject('${p.id}')">‡∂∏‡∂ö‡∂±‡∑ä‡∂±</button>`;
            } else {
                actionBtns = `<span style="font-size:10px; color:gray">‡∂Ö‡∑Ä‡∑É‡∂ª ‡∂±‡∑ê‡∂≠</span>`;
            }
            html += `<tr><td>${p.name}</td><td>${p.incomeCode || '-'}</td><td>${p.initialAmt.toFixed(2)}</td><td class="ex-amt">${e.toFixed(2)}</td><td><b>${(p.initialAmt-e).toFixed(2)}</b></td><td>${actionBtns}</td></tr>`;
        });
        document.getElementById('projectListTable').innerHTML = html + '</table>';
    }
</script>
</body>
</html>

