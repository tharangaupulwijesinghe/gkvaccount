<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <title>‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∂´ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ - ‡∂∏‡∑ú/‡∂ú‡∂∏‡∑ä‡∂¥‡∂Ç‡∂ú‡∑î‡∑Ä ‡∂ö‡∂±‡∑í‡∑Ç‡∑ä‡∂® ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂Ω‡∂∫</title>
    <style>
        :root { 
            --primary: #1b5e20; 
            --secondary: #2e7d32; 
            --accent: #fbc02d; 
            --success: #27ae60; 
            --danger: #e74c3c; 
            --light: #f9fbe7; 
            --gold: #ffeb3b; 
            --white: #ffffff; 
            --purple: #8e44ad;
            --deep-blue: #0984e3;
            --glass: rgba(255, 255, 255, 0.1);
        }
        body { font-family: 'Segoe UI', 'Iskoola Pota', sans-serif; margin: 0; background: var(--light); display: flex; }
        
        .sidebar { width: 280px; height: 100vh; background: var(--primary); color: white; position: fixed; overflow-y: auto; box-shadow: 2px 0 15px rgba(0,0,0,0.2); z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { text-align: center; padding: 25px 15px; background: #0a3d0e; color: var(--gold); font-weight: bold; font-size: 18px; border-bottom: 3px solid var(--gold); }
        .nav-link { padding: 15px 20px; display: block; color: #dcedc8; text-decoration: none; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.3s; font-size: 15px; }
        .nav-link:hover, .nav-link.active { background: var(--secondary); color: var(--gold); border-left: 5px solid var(--gold); padding-left: 25px; }
        
        .main-content { margin-left: 280px; padding: 30px; width: calc(100% - 280px); position: relative; min-height: 100vh; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 35px; perspective: 1000px; }
        .stat-card { 
            padding: 30px; border-radius: 20px; color: white; text-align: center; 
            transition: transform 0.5s, box-shadow 0.5s; 
            transform-style: preserve-3d;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            position: relative;
        }
        .stat-card:hover { 
            transform: rotateX(10deg) rotateY(-5deg) translateY(-10px); 
            box-shadow: 0 20px 35px rgba(0,0,0,0.2);
        }
        .stat-card h5 { margin: 0; font-size: 16px; opacity: 0.9; text-transform: uppercase; }
        .stat-card h2 { margin: 10px 0 0; font-size: 32px; font-weight: 800; }

        .fund-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .fund-box { 
            padding: 20px; border-radius: 15px; color: white; text-align: center; font-weight: bold; 
            cursor: pointer; transition: 0.3s; border-bottom: 5px solid rgba(0,0,0,0.2);
            display: flex; flex-direction: column; justify-content: center; min-height: 80px;
        }
        .fund-box:hover { transform: scale(1.05); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        .fund-box small { font-size: 11px; opacity: 0.8; margin-top: 5px; }

        .school-header-banner { 
            background: linear-gradient(135deg, #1b5e20 0%, #388e3c 100%); 
            color: var(--gold); padding: 50px 20px; text-align: center; border-radius: 25px; 
            margin-bottom: 35px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); border: 2px solid var(--gold);
        }

        .card { background: var(--white); padding: 30px; border-radius: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .section-title { color: var(--primary); border-left: 6px solid var(--accent); padding-left: 15px; margin-bottom: 25px; font-size: 24px; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        th, td { padding: 15px; border: 1px solid #eee; text-align: left; }
        th { background: var(--primary); color: var(--gold); font-weight: 600; text-transform: uppercase; font-size: 13px; }
        tr:hover { background-color: #f1f8e9; }

        .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .field { flex: 1; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--secondary); }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #dcedc8; border-radius: 10px; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 5px rgba(27, 94, 32, 0.2); }
        .btn { padding: 14px 25px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn:active { transform: scale(0.98); }

        .creator-brand {
            margin-top: auto;
            padding: 30px 15px;
            text-align: center;
            background: #0a3d0e;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .creator-name {
            display: block;
            color: var(--gold);
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 5px;
        }
        .creator-sub { color: #aed581; font-size: 11px; }

        .code-tag-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .code-tag { background: #fdfdfd; border: 1px solid #eee; padding: 12px; border-radius: 12px; display: flex; align-items: center; }
        .code-num { background: var(--primary); color: var(--gold); padding: 4px 10px; border-radius: 6px; margin-right: 12px; font-family: monospace; font-weight: bold; }

        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 10000; font-weight: bold; color: var(--primary); }
        @media print { .sidebar, .no-print { display: none !important; } .main-content { margin-left: 0; width: 100%; } }
        #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        
        .admin-only, .staff-only { display: none; }
    </style>
</head>
<body>

<div id="loading-overlay">‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑ê‡∂ö‡∑É‡∑ô‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì... ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂ª‡∑ê‡∂≥‡∑ì ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±.</div>

<div id="login-overlay">
    <div class="card" style="text-align:center; width: 380px; padding: 50px;">
        <h2 style="color:var(--primary); margin-bottom: 5px;">‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑è‡∂Ω‡∂± ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫</h2>
        <p style="color: #666; margin-bottom: 30px;">‡∂∏‡∑ú/‡∂ú‡∂∏‡∑ä‡∂¥‡∂Ç‡∂ú‡∑î‡∑Ä ‡∂ö‡∂±‡∑í‡∑Ç‡∑ä‡∂® ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂Ω‡∂∫</p>
        <input type="password" id="passInput" placeholder="‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±" style="text-align:center; margin-bottom:20px; font-size: 18px;">
        <button class="btn" style="width:100%; background: var(--primary); color: var(--gold);" onclick="checkLogin()">‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∂ß ‡∂á‡∂≠‡∑î‡∑Ö‡∑î ‡∑Ä‡∂±‡∑ä‡∂±</button>
        <div style="margin-top:30px;">
            <span style="color:var(--primary); font-weight: bold; font-size: 14px;">Created by: Tharanga Wijesinghe</span>
        </div>
    </div>
</div>

<div class="sidebar no-print">
    <div class="sidebar-header">‡∂∏‡∑ú/‡∂ú‡∂∏‡∑ä‡∂¥‡∂Ç‡∂ú‡∑î‡∑Ä ‡∂ö‡∂±‡∑í‡∑Ç‡∑ä‡∂® ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂Ω‡∂∫</div>
    <div style="padding-top: 10px;">
        <a class="nav-link active" id="nav-dash" onclick="showSec('dash')">üìä ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂¥‡∑î‡∑Ä‡∂ª‡∑î‡∑Ä</a>
        <a class="nav-link staff-only" id="nav-entry" onclick="showSec('entry')">üìù ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏</a>
        <a class="nav-link staff-only" id="nav-proj" onclick="showSec('proj')">üèóÔ∏è ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í</a>
        <a class="nav-link" id="nav-cashbook" onclick="openReport('CASHBOOK')">üìñ ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑ú‡∂≠</a>
        <a class="nav-link" id="nav-inc" onclick="openReport('IN')">üìà ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è</a>
        <a class="nav-link" id="nav-exp" onclick="openReport('EX')">üìâ ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è</a>
        <a class="nav-link" id="nav-bank" onclick="openReport('BANK')">üè¶ ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏</a>
        <a class="nav-link" id="nav-codes" onclick="showSec('codes')">üîë ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</a>
    </div>
    
    <div style="padding: 20px;"><button class="btn" style="background:var(--danger); color:white; width:100%;" onclick="location.reload()">‡∂â‡∑Ä‡∂≠‡∑ä ‡∑Ä‡∂±‡∑ä‡∂±</button></div>
    
    <div class="creator-brand">
        <span class="creator-sub">Designed & Developed by</span>
        <span class="creator-name">THARANGA WIJESINGHE</span>
        <span class="creator-sub">¬© 2025 All Rights Reserved</span>
    </div>
</div>

<div class="main-content">
    <div class="school-header-banner">
        <h1 style="font-size: 36px; margin: 0;">‡∂∏‡∑ú/‡∂ú‡∂∏‡∑ä‡∂¥‡∂Ç‡∂ú‡∑î‡∑Ä ‡∂ö‡∂±‡∑í‡∑Ç‡∑ä‡∂® ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂Ω‡∂∫</h1>
        <div style="margin-top: 10px; font-size: 18px; letter-spacing: 3px; opacity: 0.8;">‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫</div>
    </div>

    <div id="sec-dash" class="section">
        <h2 class="section-title">‡∑Ä‡∂≠‡∑ä‡∂∏‡∂±‡∑ä ‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫</h2>
        <div class="stat-grid">
            <div class="stat-card" style="background: var(--primary);">
                <h5>‡∂∏‡∑î‡∑Ö‡∑î ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä (DR)</h5>
                <h2 id="dash-in">0.00</h2>
            </div>
            <div class="stat-card" style="background: #a5d6a7; color: #1b5e20;">
                <h5>‡∂∏‡∑î‡∑Ö‡∑î ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä (CR)</h5>
                <h2 id="dash-ex">0.00</h2>
            </div>
            <div class="stat-card" style="background: var(--accent); color: #1b5e20;">
                <h5>‡∂¥‡∑Ä‡∂≠‡∑í‡∂± ‡∑Å‡∑ö‡∑Ç‡∂∫</h5>
                <h2 id="dash-bal">0.00</h2>
            </div>
        </div>
        
        <div class="card" style="background: #fff; border-top: 4px solid var(--accent);">
            <h3 style="text-align: center; color: var(--primary); margin-bottom: 25px;">‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑Ä‡∂≠‡∑ä‡∂∏‡∂±‡∑ä ‡∑Å‡∑ö‡∑Ç‡∂∫‡∂±‡∑ä</h3>
            <p style="text-align:center; font-size: 12px; color: #777;">(‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂∂‡∑ê‡∂Ω‡∑ì‡∂∏‡∂ß ‡∂∂‡∑ú‡∂≠‡∑ä‡∂≠‡∂∏ ‡∂∏‡∂≠ ‡∂∏‡∑Ä‡∑î‡∑É‡∂∫ ‡∂≠‡∂∂‡∂±‡∑ä‡∂±)</p>
            <div class="fund-grid" id="dash-funds"></div>
        </div>
    </div>

    <div id="sec-entry" class="section" style="display:none;">
        <h2 class="section-title">‡∂±‡∑Ä ‡∂ú‡∂±‡∑î‡∂Ø‡∑ô‡∂±‡∑î ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏</h2>
        <div class="form-row">
            <div class="card field" style="border-top: 8px solid var(--success);">
                <h3 style="color:var(--success); margin-top: 0;">‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä (‡∑Ñ‡∂ª)</h3>
                <input type="hidden" id="edit-id-in">
                <div class="form-row">
                    <div class="field"><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="inDate"></div>
                    <div class="field"><label>‡∂Ω‡∂Ø‡∑î‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</label><input type="text" id="inRef"></div>
                </div>
                <div class="form-row">
                    <div class="field"><label>‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫</label><select id="inCodeSelect"></select></div>
                    <div class="field"><label>‡∂∏‡∑î‡∂Ø‡∂Ω (‡∂ª‡∑î.)</label><input type="number" id="inAmt"></div>
                </div>
                <div class="field" style="margin-bottom: 15px;"><label>‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫</label><select id="inProjSelect"></select></div>
                <label>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</label><textarea id="inDesc" rows="2"></textarea>
                <button class="btn" style="margin-top:20px; width:100%; background: var(--success); color:white;" id="btn-save-in" onclick="saveData('IN')">‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏ ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
            </div>

            <div class="card field" style="border-top: 8px solid var(--danger);">
                <h3 style="color:var(--danger); margin-top: 0;">‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä (‡∂∂‡∑ê‡∂ª)</h3>
                <input type="hidden" id="edit-id-ex">
                <div class="form-row">
                    <div class="field"><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="exDate"></div>
                    <div class="field"><label>‡∑Ä‡∑Ä‡∑î‡∂†‡∂ª ‡∂Ö‡∂Ç‡∂ö‡∂∫</label><input type="text" id="exVoucher"></div>
                </div>
                <div class="form-row">
                    <div class="field"><label>‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</label><input type="text" id="exRef"></div>
                    <div class="field"><label>‡∂∏‡∑î‡∂Ø‡∂Ω (‡∂ª‡∑î.)</label><input type="number" id="exAmt"></div>
                </div>
                <div class="form-row">
                    <div class="field"><label>‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫</label><select id="exCodeSelect"></select></div>
                    <div class="field"><label>‡∂∏‡∑ñ‡∂Ω‡∑è‡∑Å‡∑ä‚Äç‡∂ª ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω</label><select id="exSourceSelect"></select></div>
                </div>
                <div class="field" style="margin-bottom: 15px;"><label>‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫</label><select id="exProjSelect"></select></div>
                <label>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</label><textarea id="exDesc" rows="2"></textarea>
                <button class="btn" style="margin-top:20px; width:100%; background: var(--danger); color:white;" id="btn-save-ex" onclick="saveData('EX')">‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
            </div>
        </div>

        <div class="card admin-only">
            <h4 onclick="toggleOpeningSec()" style="cursor:pointer; color:var(--primary); text-align: center;">‚öôÔ∏è ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫‡∂±‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂∏‡∑ô‡∑Ñ‡∑í ‡∂ö‡∑ä‡∂Ω‡∑í‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</h4>
            <div id="op-sec" style="display:none; padding:20px; border:2px dashed #ddd; border-radius:15px; margin: 20px 0;">
                <div class="form-row">
                    <div class="field"><label>‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω</label><select id="opCodeSelect"></select></div>
                    <div class="field"><label>‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫</label><input type="number" id="opAmt"></div>
                    <button class="btn" style="align-self: flex-end; background: var(--accent); color: var(--primary);" onclick="saveOpening()">‡∑Å‡∑ö‡∑Ç‡∂∫ ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
                </div>
            </div>
        </div>
        <div class="card">
            <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px;">‡∂∏‡∑ë‡∂≠‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ú‡∂±‡∑î‡∂Ø‡∑ô‡∂±‡∑î</h3>
            <div id="recent-transactions-table" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div id="sec-proj" class="section" style="display:none;">
        <h2 class="section-title">‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´‡∂∫</h2>
        <div class="card">
            <div class="form-row">
                <input type="hidden" id="edit-proj-id">
                <div class="field"><label>‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∂±‡∑è‡∂∏‡∂∫</label><input type="text" id="projName" placeholder="‡∂ã‡∂Ø‡∑è: ‡∂≠‡∑è‡∂¥‡∑ä‡∂¥‡∂∫ ‡∂â‡∂Ø‡∑í‡∂ö‡∑í‡∂ª‡∑ì‡∂∏"></div>
                <div class="field"><label>‡∂á‡∑É‡∑ä‡∂≠‡∂∏‡∑ö‡∂±‡∑ä‡∂≠‡∑î‡∑Ä (‡∂ª‡∑î.)</label><input type="number" id="projEst"></div>
                <button class="btn" style="align-self: flex-end; background: var(--primary); color: var(--gold);" onclick="saveProject()">‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫ ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
            </div>
        </div>
        <div class="card"><div id="project-list-table"></div></div>
        
        <div id="proj-detail-view" class="card" style="display:none; border-top: 5px solid var(--primary);">
            <h3 id="detail-proj-name" style="color:var(--primary);"></h3>
            <div id="project-expenses-list"></div>
            <button class="btn" style="margin-top:20px; background:#95a5a6; color:white;" onclick="document.getElementById('proj-detail-view').style.display='none'">‡∑Ä‡∑É‡∂±‡∑ä‡∂±</button>
        </div>
    </div>

    <div id="sec-report" class="section" style="display:none;">
        <div id="printable-area" class="card">
            <h2 id="report-header-title" style="text-align:center; color: var(--primary);"></h2>
            <p id="report-date-range" style="text-align:center; font-weight:bold;"></p>
            <div id="report-content"></div>
            
            <div class="no-print" style="margin-top:30px; display:flex; gap:15px; background:#f9f9f9; padding:25px; border-radius:15px; border: 1px solid #eee;">
                <div class="field"><label>‡∑É‡∑í‡∂ß</label><input type="date" id="repFrom"></div>
                <div class="field"><label>‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è</label><input type="date" id="repTo"></div>
                <div class="field" id="filter-box" style="display:none;"><label>‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫</label><select id="repFilter"></select></div>
                <button class="btn" style="align-self: flex-end; background: var(--primary); color: var(--gold);" onclick="generateReport()">‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±</button>
                <button class="btn" style="align-self: flex-end; background: var(--secondary); color: white;" onclick="window.print()">Print Report</button>
            </div>
        </div>
    </div>

    <div id="sec-codes" class="section" style="display:none;">
        <h2 class="section-title">‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠ ‡∑É‡∑Ñ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª</h2>
        <div class="form-row">
            <div class="card field" style="border-top: 5px solid var(--primary);">
                <h3 style="color:var(--primary);">‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠ (S-Codes)</h3>
                <div id="codes-s" class="code-tag-container"></div>
            </div>
            <div class="card field" style="border-top: 5px solid var(--danger);">
                <h3 style="color:var(--danger);">‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠ (Expense Codes)</h3>
                <div id="codes-ex" class="code-tag-container"></div>
            </div>
        </div>
    </div>

    <div class="footer-credit no-print" style="text-align: center; color: #999; padding: 40px;">
        ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í ‡∂±‡∑í‡∂ª‡∑ä‡∂∏‡∑è‡∂´‡∂∫ : ‡∂≠‡∂ª‡∂Ç‡∂ú ‡∑Ä‡∑í‡∂¢‡∑ö‡∑É‡∑í‡∂Ç‡∑Ñ | 0777944308
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzmSGS_JXsNWsbxgGQjR7bL2nUlJr-PAmBFyjVwk8rXCG8rESQSjkIMXto6WTRCu_UniA/exec";

    const S_CODES = ["S1","S2","S3","S4","S5","S6","S7","S8","S9","S10"];
    const EX_CODES = ["REx1","REx2","REx3","REx4","REx5","REx6","REx7","CEx1","CEx2","CEx3","CEx4","CEx5","CEx6"];
    const CODE_INFO = {
        "S1":"‡∂í‡∂ö‡∑è‡∂∂‡∂Ø‡∑ä‡∂∞ ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∑É‡∑Ñ ‡∂¥‡∑Ö‡∑è‡∂≠‡∑ä ‡∑É‡∂∑‡∑è ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä", "S2":"‡∑É‡∑Ñ‡∂∫‡∑ù‡∂ú‡∑í‡∂≠‡∑è ‡∂ú‡∑í‡∑Ä‡∑í‡∑É‡∑î‡∂∏‡∑ä ‡∂∫‡∂ß‡∂≠‡∑ö ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∂± ‡∑Ä‡∑ê‡∂©‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∑Ñ‡∑è ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä", "S3":"‡∂ª‡∂¢‡∂∫‡∑ö ‡∂Ü‡∂∞‡∑è‡∂ª", "S4":"‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∂¥‡∑è‡∂Ø‡∂ö ‡∂â‡∂ú‡∑ô‡∂±‡∑î‡∂∏‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∂ª‡∑ä‡∂∞‡∂± ‡∂¥‡∑ä‚Äç‡∂ª‡∂Ø‡∑è‡∂±‡∂∫‡∂±‡∑ä, ‡∂ú‡∑î‡∂´‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂∫‡∑ô‡∂Ø‡∑Ä‡∑î‡∂∏‡∑ä ‡∑Ñ‡∑è ‡∂ã‡∑É‡∑É‡∑ä ‡∂∏‡∂ß‡∑ä‡∂ß‡∂∏‡∑ö ‡∂â‡∂ú‡∑ô‡∂±‡∑î‡∂∏‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä", "S5":"‡∂ª‡∂¢‡∂∫ ‡∑Ä‡∑í‡∑É‡∑í‡∂±‡∑ä ‡∂Ö‡∂±‡∑î‡∂∏‡∂≠ ‡∑Ñ‡∑è ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∂ª‡∑è‡∂¢‡∑ä‚Äç‡∂∫ ‡∂±‡∑ú‡∑Ä‡∂± ‡∑É‡∂Ç‡∑Ä‡∑í‡∂∞‡∑è‡∂± ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂Ü‡∂∞‡∑è‡∂ª", "S6":"‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î‡∑Ä ‡∑Ä‡∑ô‡∂±‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∑É‡∑ä‡∑Ä ‡∂ö‡∑ê‡∂∏‡∑ê‡∂≠‡∑ä‡∂≠‡∑ô‡∂±‡∑ä ‡∂Ø‡∑è‡∂∫‡∂ö‡∂≠‡∑ä‡∑Ä‡∂∫ ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂± ‡∂ï‡∂±‡∑ë‡∂∏ ‡∂¥‡∑è‡∂ª‡∑ä‡∑Å‡∑Ä‡∂∫‡∂ö ‡∂¥‡∂ª‡∑í‡∂≠‡∑ä‚Äç‡∂∫‡∑è‡∂ú", "S7":"‡∂¥‡∑è‡∑É‡∂Ω‡∂ß ‡∂Ö‡∂∫‡∂≠‡∑ä ‡∑Ä‡∂≠‡∑ä‡∂ö‡∂∏‡∑ä ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä ‡∂ã‡∂¥‡∂∫‡∑è ‡∂ú‡∂±‡∑ä‡∂±‡∑è ‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏‡∑ä", "S8":"‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∑É‡∂Ç‡∑Ä‡∂ª‡∑ä‡∂∞‡∂± ‡∑É‡∂∏‡∑í‡∂≠‡∑í ‡∑É‡∑è‡∂∏‡∑è‡∂¢‡∑í‡∂ö ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä", "S9":"‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂â‡∂ú‡∑ô‡∂±‡∑î‡∂∏‡∑ä ‡∂â‡∂ú‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í‡∂∫‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∂Ö‡∂≠‡∑ä‚Äç‡∂∫‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∂ö‡∂∏‡∑ä ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä", "S10":"‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∑É‡∂Ç‡∑Ä‡∂ª‡∑ä‡∂∞‡∂± ‡∑É‡∂∏‡∑í‡∂≠‡∑í‡∂∫ ‡∂∏‡∂ü‡∑í‡∂±‡∑ä ‡∂≠‡∑ì‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂±‡∑î ‡∂Ω‡∂∂‡∂± ‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂Ö‡∂≠‡∑ä‚Äç‡∂∫‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂¥‡∑í‡∂∫‡∑Ä‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑Ä‡∂± ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä",
        "REx1":"‡∑Ä‡∑í‡∑Ç‡∂∫ ‡∂∏‡∑è‡∂Ω‡∑è ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∂¥‡∑î‡∂±‡∂ª‡∑è‡∑Ä‡∂ª‡∑ä‡∂≠‡∂± ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä", "REx2":"‡∂ã‡∂¥‡∂Ø‡∑ö‡∑Å‡∂±, ‡∂ã‡∑É‡∑É‡∑ä ‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂± ‡∑Ñ‡∑è ‡∑Ä‡∑í‡∑Ç‡∂∫ ‡∑É‡∂∏‡∂ú‡∑è‡∂∏‡∑ì ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∂ö‡∂∏‡∑ä", "REx3":"‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂± ‡∂¥‡∂ª‡∑í‡∂¥‡∑è‡∂Ω‡∂± ‡∑Ñ‡∑è ‡∂ã‡∂¥‡∂∫‡∑ù‡∂ú‡∑í‡∂≠‡∑è ‡∑É‡∑ö‡∑Ä‡∑è ‡∑Ñ‡∑è ‡∑É‡∑î‡∂∑‡∑É‡∑è‡∂∞‡∂± ‡∂ö‡∂ß‡∂∫‡∑î‡∂≠‡∑î", "REx4":"‡∂ö‡∑è‡∂ª‡∑ä‡∂∫ ‡∂∏‡∂´‡∑ä‡∂©‡∂Ω ‡∂¥‡∑è‡∂ª‡∑í‡∑Å‡∑ä‚Äç‡∂ª‡∂∏‡∑í‡∂ö", "REx5":"‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∂∑‡∑è‡∂´‡∑ä‡∂© ‡∑Ñ‡∑è ‡∂ã‡∂¥‡∂ö‡∂ª‡∂´ ‡∂±‡∂©‡∂≠‡∑ä‡∂≠‡∑î/‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è", "REx6":"‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂ú‡∑ú‡∂©‡∂±‡∑ê‡∂ú‡∑í‡∂Ω‡∑í ‡∑É‡∑î‡∑Ö‡∑î ‡∂±‡∂©‡∂≠‡∑ä‡∂≠‡∑î/‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è", "REx7":"‡∂¥‡∑Ä‡∑í‡∂≠‡∑ä‚Äç‡∂ª‡∂≠‡∑è ‡∑Ñ‡∑è ‡∂¥‡∑í‡∂ª‡∑í‡∑É‡∑í‡∂Ø‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä", 
        "CEx1":"‡∂∏‡∑ñ‡∂Ω‡∑í‡∂ö ‡∂¥‡∑Ñ‡∑É‡∑î‡∂ö‡∂∏‡∑ä - ‡∂±‡∑Ä ‡∑É‡∑ê‡∂¥‡∂∫‡∑ì‡∂∏‡∑ä", "CEx2":"‡∑Ä‡∑í‡∑Ç‡∂∫ ‡∂∏‡∑è‡∂Ω‡∑è ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä", "CEx3":"‡∂¥‡∑î‡∑É‡∑ä‡∂≠‡∂ö‡∑è‡∂Ω ‡∂¥‡∑ú‡∂≠‡∑ä ‡∂∏‡∑í‡∂Ω‡∂ß ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ä", "CEx4":"‡∂ú‡∑ú‡∂©‡∂±‡∑ê‡∂ú‡∑í‡∂Ω‡∑í ‡∂±‡∑Ä ‡∂â‡∂Ø‡∑í‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä, ‡∑Ä‡∑ê‡∂©‡∑í‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä ‡∑Ñ‡∑è ‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä", "CEx5":"‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∂ã‡∂¥‡∂ö‡∂ª‡∂´ ‡∂∏‡∑í‡∂Ω‡∂ß ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ä", "CEx6":"‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∂Ü‡∂∞‡∑è‡∂ª"
    };
    const COLORS = ["#2e7d32", "#f9a825", "#388e3c", "#fbc02d", "#43a047", "#fdd835", "#4caf50", "#ffeb3b", "#66bb6a", "#ffee58"];

    let currentReport = '';
    let userRole = '';

    async function checkLogin() {
        const pass = document.getElementById('passInput').value;
        if(pass === "MyApp") { userRole = 'ADMIN'; } 
        else if(pass === "Staff123") { userRole = 'STAFF'; } 
        else if(pass === "Guest") { userRole = 'GUEST'; } 
        else { alert("‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í!"); return; }
        
        document.getElementById('login-overlay').style.display = 'none';
        applyPermissions();
        await fetchRemoteData(); 
        init();
    }

    async function fetchRemoteData() {
        if(!GOOGLE_SCRIPT_URL.includes("http")) return;
        toggleLoading(true);
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            const data = await response.json();
            localStorage.setItem('sch_db', JSON.stringify(data));
        } catch (e) { console.error("Data fetch error", e); }
        toggleLoading(false);
    }

    function toggleLoading(show) {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    }

    function applyPermissions() {
        if(userRole === 'ADMIN' || userRole === 'STAFF') {
            document.querySelectorAll('.staff-only').forEach(el => el.style.display = 'block');
        }
        if(userRole === 'ADMIN') {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
        }
    }

    function init() {
        populateOptions();
        refreshDashboard();
        renderCodesList();
    }

    function toggleOpeningSec() {
        const el = document.getElementById('op-sec');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function populateOptions() {
        const selects = ['inCodeSelect', 'exSourceSelect', 'opCodeSelect'];
        selects.forEach(sId => {
            const el = document.getElementById(sId);
            if(el) {
                el.innerHTML = '';
                S_CODES.forEach(c => el.innerHTML += `<option value="${c}">${c} - ${CODE_INFO[c]}</option>`);
            }
        });
        const exCodeEl = document.getElementById('exCodeSelect');
        if(exCodeEl) {
            exCodeEl.innerHTML = '';
            EX_CODES.forEach(c => exCodeEl.innerHTML += `<option value="${c}">${c} - ${CODE_INFO[c]}</option>`);
        }
        updateProjectSelects();
    }

    function renderCodesList() {
        document.getElementById('codes-s').innerHTML = S_CODES.map(c => 
            `<div class="code-tag"><span class="code-num">${c}</span>${CODE_INFO[c]}</div>`
        ).join('');
        
        document.getElementById('codes-ex').innerHTML = EX_CODES.map(c => 
            `<div class="code-tag"><span class="code-num" style="background:var(--danger); color:white;">${c}</span>${CODE_INFO[c]}</div>`
        ).join('');
    }

    async function saveData(type) {
        const prefix = type === 'IN' ? 'in' : 'ex';
        const id = document.getElementById('edit-id-' + prefix).value;
        const data = {
            id: id ? parseInt(id) : Date.now(),
            date: document.getElementById(prefix + 'Date').value,
            ref: document.getElementById(prefix + 'Ref').value,
            vouch: type === 'EX' ? document.getElementById('exVoucher').value : '',
            code: document.getElementById(prefix + 'CodeSelect').value,
            amt: parseFloat(document.getElementById(prefix + 'Amt').value || 0),
            desc: document.getElementById(prefix + 'Desc').value,
            type: type,
            source: type === 'EX' ? document.getElementById('exSourceSelect').value : document.getElementById('inCodeSelect').value,
            proj: document.getElementById(prefix + 'ProjSelect').value,
            status: type === 'IN' ? true : false,
            isOp: false
        };
        if(!data.date || data.amt <= 0) return alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂Ø‡∑í‡∂±‡∂∫ ‡∑É‡∑Ñ ‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.");

        toggleLoading(true);
        try {
            if(GOOGLE_SCRIPT_URL.includes("http")) {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(data)
                });
            }

            let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
            if(id) db = db.filter(x => x.id !== parseInt(id));
            db.push(data);
            localStorage.setItem('sch_db', JSON.stringify(db));

            alert("‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∑É‡∑î‡∂ª‡∑ê‡∂ö‡∑í‡∂´‡∑í!");
            resetForms();
            loadRecentTable();
            refreshDashboard();
        } catch (e) { alert("‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∑É‡∑í‡∂Ø‡∑î‡∑Ä‡∑í‡∂∫!"); }
        toggleLoading(false);
    }

    async function saveOpening() {
        const code = document.getElementById('opCodeSelect').value;
        const amt = parseFloat(document.getElementById('opAmt').value || 0);
        if(amt <= 0) return alert("‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
        const data = { id: Date.now(), date: "2024-01-01", ref: 'OPENING', vouch: '', code: code, amt: amt, desc: '‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫', type: 'IN', source: code, isOp: true, status: true };
        
        toggleLoading(true);
        if(GOOGLE_SCRIPT_URL.includes("http")) {
            await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
        }
        let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        db.push(data);
        localStorage.setItem('sch_db', JSON.stringify(db));
        toggleLoading(false);
        
        alert("‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫ ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì!");
        refreshDashboard();
        toggleOpeningSec();
    }

    function openReport(type) {
        currentReport = type;
        showSec('report');
        document.getElementById('filter-box').style.display = (type === 'IN' || type === 'EX') ? 'block' : 'none';
        if(type === 'IN' || type === 'EX') {
            const list = type === 'IN' ? S_CODES : EX_CODES;
            document.getElementById('repFilter').innerHTML = '<option value="ALL">‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂ö‡∑ö‡∂≠‡∂∫‡∂±‡∑ä</option>' + list.map(c => `<option value="${c}">${c} - ${CODE_INFO[c]}</option>`).join('');
        }
        generateReport();
    }

    function generateReport() {
        const db = JSON.parse(localStorage.getItem('sch_db') || '[]').sort((a,b) => new Date(a.date) - new Date(b.date));
        const from = document.getElementById('repFrom').value;
        const to = document.getElementById('repTo').value;
        const filter = document.getElementById('repFilter').value;
        let html = '';

        if(currentReport === 'CASHBOOK') {
            document.getElementById('report-header-title').innerText = "‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑ú‡∂≠ (Cash Book)";
            
            // Calculate actual Opening Balance (all records marked isOp:true)
            let bf = db.filter(r => r.isOp === true).reduce((a,b) => a + b.amt, 0);
            
            // Also include transactions BEFORE the "from" date into B/F balance
            if(from) {
                bf += db.filter(r => !r.isOp && new Date(r.date) < new Date(from)).reduce((a,b) => a + (b.type==='IN'?b.amt:-b.amt), 0);
            }

            html = '<table><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫ (‡∂ö‡∑ö‡∂≠‡∂∫)</th><th>‡∂Ω‡∂Ø‡∑î‡∂¥‡∂≠‡∑ä/‡∑Ä‡∑Ä‡∑î‡∂†‡∂ª/‡∂†‡∑ô‡∂ö‡∑ä</th><th>‡∑Ñ‡∂ª DR (‡∂ª‡∑î.)</th><th>‡∂∂‡∑ê‡∂ª CR (‡∂ª‡∑î.)</th><th>‡∑Å‡∑ö‡∑Ç‡∂∫ (‡∂ª‡∑î.)</th></tr>';
            html += `<tr style="background:#f1f2f6; font-weight:bold;"><td colspan="5">‡∑Ä‡∂ª‡∑ä‡∑Ç‡∂∫ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂∫‡∑ö ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂∫‡∂ß ‡∂ú‡∑ô‡∂± ‡∂Ü ‡∑Å‡∑ö‡∑Ç‡∂∫ (B/F Balance)</td><td style="text-align:right;">${bf.toLocaleString(undefined,{minimumFractionDigits:2})}</td></tr>`;
            
            let bal = bf;
            // Filter out records where isOp is true so they don't appear as rows
            db.filter(r => !r.isOp && (!from || r.date >= from) && (!to || r.date <= to)).forEach(r => {
                bal += (r.type === 'IN' ? r.amt : -r.amt);
                let refDisp = r.type === 'IN' ? r.ref : `${r.vouch || '-'} / ${r.ref || '-'}`;
                html += `<tr><td>${r.date}</td><td>${r.desc} <small>(${r.source})</small></td><td>${refDisp}</td><td>${r.type==='IN'?r.amt.toFixed(2):'-'}</td><td>${r.type==='EX'?r.amt.toFixed(2):'-'}</td><td style="text-align:right; font-weight:bold;">${bal.toFixed(2)}</td></tr>`;
            });
        } else if(currentReport === 'BANK') {
            document.getElementById('report-header-title').innerText = "‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏‡∑ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä";
            const cashBal = db.reduce((a,b) => a + (b.type==='IN'?b.amt:-b.amt), 0);
            const pending = db.filter(r => r.type === 'EX' && !r.status);
            const pTotal = pending.reduce((a,b) => a + b.amt, 0);
            html = `<div style="padding:20px; border:1px solid #ddd; border-radius:10px; margin-bottom:20px;">
                    <h3>‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑ú‡∂≠‡∑ä ‡∑Å‡∑ö‡∑Ç‡∂∫: ‡∂ª‡∑î. ${cashBal.toLocaleString()}</h3>
                    <h3 style="color:var(--danger)">(+) ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂¥‡∂≠‡∑ä ‡∂±‡∑ú‡∂ö‡∑Ö ‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä: ‡∂ª‡∑î. ${pTotal.toLocaleString()}</h3>
                    <hr><h2>‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑Å‡∑ö‡∑Ç‡∂∫: ‡∂ª‡∑î. ${(cashBal+pTotal).toLocaleString()}</h2></div>`;
            html += '<table><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∑Ä‡∑Ä‡∑î‡∂†‡∂ª ‡∂Ö‡∂Ç‡∂ö‡∂∫</th><th>‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω</th><th>‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä</th></tr>';
            pending.forEach(p => {
                const clearBtn = userRole === 'ADMIN' ? `<button class="btn" style="padding:5px 10px; background:var(--success); color:white; font-size:11px;" onclick="toggleStatus(${p.id})">Clear Now</button>` : '-';
                html += `<tr><td>${p.date}</td><td>${p.vouch || '-'}</td><td>${p.ref || '-'}</td><td>${p.desc}</td><td>${p.amt.toFixed(2)}</td><td>${clearBtn}</td></tr>`;
            });
        } else {
            document.getElementById('report-header-title').innerText = currentReport === 'IN' ? "‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏‡∑ä ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä" : "‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä";
            const codes = filter === 'ALL' ? (currentReport === 'IN' ? S_CODES : EX_CODES) : [filter];
            html = '<table><tr><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th style="text-align:right;">‡∂∏‡∑î‡∑Ö‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω (‡∂ª‡∑î.)</th></tr>';
            let total = 0;
            codes.forEach(c => {
                // Include Opening Balances in Income analysis if it's an "IN" report
                const amt = db.filter(r => r.type === currentReport && r.code === c && (!from || r.date >= from) && (!to || r.date <= to)).reduce((a,b) => a + b.amt, 0);
                html += `<tr><td><b style="color:var(--primary)">${c}</b></td><td>${CODE_INFO[c]}</td><td style="text-align:right;">${amt.toLocaleString(undefined,{minimumFractionDigits:2})}</td></tr>`;
                total += amt;
            });
            html += `<tr style="background:#f1f2f6; font-weight:bold;"><td colspan="2">‡∂∏‡∑î‡∑Ö‡∑î ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä</td><td style="text-align:right;">${total.toLocaleString(undefined,{minimumFractionDigits:2})}</td></tr>`;
        }
        document.getElementById('report-content').innerHTML = html + '</table>';
    }

    function refreshDashboard() {
        const db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        const tin = db.filter(r => r.type === 'IN').reduce((a,b) => a + b.amt, 0);
        const tex = db.filter(r => r.type === 'EX').reduce((a,b) => a + b.amt, 0);
        
        animateValue("dash-in", 0, tin, 1000);
        animateValue("dash-ex", 0, tex, 1000);
        animateValue("dash-bal", 0, (tin-tex), 1000);

        let fundHtml = '';
        S_CODES.forEach((s, i) => {
            const fundTransactions = db.filter(r => r.type === 'IN' && r.source === s);
            const bal = db.filter(r => r.source === s).reduce((a,b) => a + (b.type==='IN'?b.amt:-b.amt), 0);
            
            let incomeListText = fundTransactions.length > 0 
                ? "‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä:\n" + fundTransactions.map(t => `${t.isOp ? '‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö' : t.date}: ‡∂ª‡∑î. ${t.amt.toFixed(2)} (${t.desc})`).join('\n')
                : "‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∂ö‡∑í‡∑É‡∑í‡∑Ä‡∂ö‡∑ä ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠";

            fundHtml += `<div class="fund-box" style="background:${COLORS[i%COLORS.length]}; color: ${i%2==0 ? 'white' : '#1b5e20'}" title="${incomeListText}">
                <div>${s}</div>
                <div style="font-size:18px;">‡∂ª‡∑î. ${bal.toLocaleString()}</div>
                <small>${CODE_INFO[s]}</small>
            </div>`;
        });
        document.getElementById('dash-funds').innerHTML = fundHtml;
    }

    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        const range = end - start;
        const startTime = new Date().getTime();
        const timer = setInterval(() => {
            const now = new Date().getTime();
            const progress = Math.min((now - startTime) / duration, 1);
            const value = start + (range * progress);
            obj.innerHTML = value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            if (progress === 1) clearInterval(timer);
        }, 20);
    }

    function toggleStatus(id) {
        let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        let itm = db.find(x => x.id === id);
        if(itm) itm.status = !itm.status;
        localStorage.setItem('sch_db', JSON.stringify(db));
        generateReport();
    }

    function loadRecentTable() {
        const db = JSON.parse(localStorage.getItem('sch_db') || '[]').sort((a,b) => b.id - a.id);
        let html = '<table><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω</th><th>‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫</th><th>‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä</th></tr>';
        db.slice(0,8).forEach(r => {
            const actionBtns = userRole === 'ADMIN' ? 
                `<button class="btn" style="padding:5px 10px; background:orange; color:white; font-size:11px;" onclick="editData(${r.id})">Edit</button>
                 <button class="btn" style="padding:5px 10px; background:red; color:white; font-size:11px;" onclick="deleteData(${r.id})">Del</button>` : '-';
            
            html += `<tr><td>${r.isOp ? '‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö' : r.date}</td><td>${r.desc}</td>
            <td style="font-weight:bold; color:${r.type==='IN'?'green':'red'}">${r.amt.toFixed(2)}</td>
            <td><small>${r.type==='IN'?'‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏':'‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏'}</small></td>
            <td>${actionBtns}</td></tr>`;
        });
        document.getElementById('recent-transactions-table').innerHTML = html + '</table>';
    }

    function editData(id) {
        const db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        const r = db.find(x => x.id === id); if(!r) return;
        const p = r.type === 'IN' ? 'in' : 'ex';
        showSec('entry');
        document.getElementById('edit-id-'+p).value = r.id;
        document.getElementById(p+'Date').value = r.date;
        document.getElementById(p+'Ref').value = r.ref;
        if(r.type==='EX') document.getElementById('exVoucher').value = r.vouch || '';
        document.getElementById(p+'CodeSelect').value = r.code;
        document.getElementById(p+'Amt').value = r.amt;
        document.getElementById(p+'Desc').value = r.desc;
        document.getElementById(p+'ProjSelect').value = r.proj;
        if(r.type==='EX') document.getElementById('exSourceSelect').value = r.source;
        document.getElementById('btn-save-'+p).innerText = "‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂±‡∑ä‡∂±";
    }

    function deleteData(id) {
        if(confirm("‡∂∏‡∑ô‡∂∏ ‡∂Ø‡∂≠‡∑ä‡∂≠‡∂∫ ‡∂∏‡∂ö‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂∂‡∑Ä ‡∑É‡∑Ñ‡∂≠‡∑í‡∂ö‡∂Ø?")) {
            let db = JSON.parse(localStorage.getItem('sch_db') || '[]');
            db = db.filter(x => x.id !== id);
            localStorage.setItem('sch_db', JSON.stringify(db));
            loadRecentTable(); refreshDashboard();
        }
    }

    function saveProject() {
        const name = document.getElementById('projName').value;
        const est = parseFloat(document.getElementById('projEst').value || 0);
        if(!name) return alert("‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∂±‡∑è‡∂∏‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.");
        let projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        projs.push({ id: Date.now(), name, est });
        localStorage.setItem('sch_projs', JSON.stringify(projs));
        document.getElementById('projName').value = ''; document.getElementById('projEst').value = '';
        updateProjectSelects(); renderProjectList();
        alert("‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì.");
    }

    function renderProjectList() {
        const projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        const db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        let html = '<table><tr><th>‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∂±‡∑è‡∂∏‡∂∫</th><th>‡∂á‡∑É‡∑ä‡∂≠‡∂∏‡∑ö‡∂±‡∑ä‡∂≠‡∑î‡∑Ä (‡∂ª‡∑î.)</th><th>‡∂∏‡∑ö ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏ (‡∂ª‡∑î.)</th><th>‡∑Å‡∑ö‡∑Ç‡∂∫</th><th>‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä</th></tr>';
        projs.forEach(p => {
            const spent = db.filter(r => r.proj === p.name && r.type === 'EX').reduce((a,b) => a + b.amt, 0);
            const bal = p.est - spent;
            html += `<tr><td><b>${p.name}</b></td><td>${p.est.toLocaleString()}</td><td style="color:red">${spent.toLocaleString()}</td><td style="font-weight:bold; color:${bal<0?'red':'green'}">${bal.toLocaleString()}</td>
            <td><button class="btn" style="padding:5px 10px; background:var(--primary); color:var(--gold); font-size:11px;" onclick="viewProjectDetails('${p.name}')">View Details</button></td></tr>`;
        });
        document.getElementById('project-list-table').innerHTML = html + '</table>';
    }

    function viewProjectDetails(projName) {
        const db = JSON.parse(localStorage.getItem('sch_db') || '[]');
        const projData = db.filter(r => r.proj === projName);
        document.getElementById('detail-proj-name').innerText = "‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫: " + projName;
        let html = '<table><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω (‡∂ª‡∑î.)</th><th>‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫</th></tr>';
        projData.forEach(r => { html += `<tr><td>${r.date}</td><td>${r.desc}</td><td>${r.amt.toFixed(2)}</td><td>${r.type === 'IN' ? '‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏' : '‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏'}</td></tr>`; });
        if(projData.length === 0) html = '<p style="text-align:center; padding:20px;">‡∂∏‡∑ô‡∂∏ ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂∏‡∑ô‡∂≠‡∑ô‡∂ö‡∑ä ‡∂ú‡∂±‡∑î‡∂Ø‡∑ô‡∂±‡∑î ‡∑É‡∑í‡∂Ø‡∑î‡∂ö‡∂ª ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠.</p>';
        else html += '</table>';
        document.getElementById('project-expenses-list').innerHTML = html;
        document.getElementById('proj-detail-view').style.display = 'block';
        document.getElementById('proj-detail-view').scrollIntoView({behavior: "smooth"});
    }

    function updateProjectSelects() {
        const projs = JSON.parse(localStorage.getItem('sch_projs') || '[]');
        ['inProjSelect', 'exProjSelect'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.innerHTML = '<option value=\"\">‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫‡∂ö‡∑ä ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠</option>';
                projs.forEach(p => el.innerHTML += `<option value=\"${p.name}\">${p.name}</option>`);
            }
        });
    }

    function showSec(id) {
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById('sec-' + id).style.display = 'block';
        document.getElementById('nav-' + id)?.classList.add('active');
        if(id === 'entry') loadRecentTable();
        if(id === 'proj') renderProjectList();
        if(id === 'dash') refreshDashboard();
        window.scrollTo(0,0);
    }

    function resetForms() {
        document.querySelectorAll('input, textarea').forEach(i => i.value = '');
        document.getElementById('btn-save-in').innerText = "‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏ ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±";
        document.getElementById('btn-save-ex').innerText = "‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±";
        document.getElementById('edit-id-in').value = ''; document.getElementById('edit-id-ex').value = '';
    }
</script>
</body>
</html>
